#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Check pentest logs via API to see if it's really running"""

import requests
import json
import sys
import os
from datetime import datetime

# Fix encoding for Windows
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

API_BASE = "https://pentest.red/api"

def get_pentests():
    """Get all pentests"""
    try:
        r = requests.get(f"{API_BASE}/pentests", timeout=10)
        if r.status_code == 200:
            return r.json()
        else:
            print(f"ERROR: Status {r.status_code}")
            print(r.text[:500])
            return []
    except Exception as e:
        print(f"ERROR: {e}")
        return []

def get_pentest_logs(pentest_id):
    """Get logs for a pentest"""
    try:
        r = requests.get(f"{API_BASE}/pentests/{pentest_id}/logs", timeout=10)
        if r.status_code == 200:
            return r.json()
        else:
            print(f"ERROR: Status {r.status_code}")
            print(r.text[:500])
            return []
    except Exception as e:
        print(f"ERROR: {e}")
        return []

def get_pentest_status(pentest_id):
    """Get status for a pentest"""
    try:
        r = requests.get(f"{API_BASE}/pentests/{pentest_id}/status", timeout=10)
        if r.status_code == 200:
            return r.json()
        else:
            return None
    except Exception as e:
        print(f"ERROR: {e}")
        return None

def format_timestamp(ts):
    """Format ISO timestamp"""
    try:
        dt = datetime.fromisoformat(ts.replace('Z', '+00:00'))
        return dt.strftime('%Y-%m-%d %H:%M:%S')
    except:
        return ts

def analyze_logs(logs):
    """Analyze logs to determine if pentest is really running"""
    if not logs:
        return {
            'has_logs': False,
            'is_running': False,
            'is_simulation': False,
            'has_shannon': False,
            'has_errors': False,
            'last_log': None
        }
    
    analysis = {
        'has_logs': True,
        'is_running': False,
        'is_simulation': False,
        'has_shannon': False,
        'has_errors': False,
        'has_process': False,
        'has_completion': False,
        'log_count': len(logs),
        'last_log': logs[-1] if logs else None,
        'shannon_logs': [],
        'error_logs': [],
        'process_logs': []
    }
    
    for log in logs:
        msg = log.get('message', '').lower()
        level = log.get('level', '')
        
        # Check for simulation
        if 'симуляц' in msg or 'simulation' in msg:
            analysis['is_simulation'] = True
        
        # Check for Shannon
        if 'shannon' in msg or 'temporal' in msg:
            analysis['has_shannon'] = True
            analysis['shannon_logs'].append(log)
        
        # Check for process
        if 'процесс запущен' in msg or 'process' in msg or 'pid' in msg:
            analysis['has_process'] = True
            analysis['process_logs'].append(log)
        
        # Check for errors
        if level == 'error' or 'ошибка' in msg or 'error' in msg:
            analysis['has_errors'] = True
            analysis['error_logs'].append(log)
        
        # Check for completion
        if 'завершен' in msg or 'completed' in msg or 'успешно' in msg:
            analysis['has_completion'] = True
        
        # Check if running
        if 'запущен' in msg or 'running' in msg or 'начинается' in msg:
            analysis['is_running'] = True
    
    return analysis

def main():
    print("=" * 70)
    print("CHECKING PENTEST LOGS")
    print("=" * 70)
    
    # Get all pentests
    print("\n1. Getting pentests list...")
    pentests = get_pentests()
    
    if not pentests:
        print("   No pentests found")
        return
    
    print(f"   Found {len(pentests)} pentest(s)")
    
    # Find running or latest pentest
    running_pentests = [p for p in pentests if p.get('status') == 'running']
    if running_pentests:
        print(f"\n   Found {len(running_pentests)} running pentest(s)")
        pentest = running_pentests[0]
    else:
        print("\n   No running pentests, checking latest...")
        pentest = pentests[0]  # Latest
    
    print(f"\n2. Checking pentest: {pentest.get('name', 'N/A')}")
    print(f"   ID: {pentest.get('id', 'N/A')}")
    print(f"   Status: {pentest.get('status', 'N/A')}")
    print(f"   Target: {pentest.get('targetUrl', 'N/A')}")
    
    # Get logs
    print(f"\n3. Getting logs...")
    logs = get_pentest_logs(pentest['id'])
    
    if not logs:
        print("   No logs found")
        return
    
    print(f"   Found {len(logs)} log entries")
    
    # Analyze logs
    print(f"\n4. Analyzing logs...")
    analysis = analyze_logs(logs)
    
    print(f"\n   Analysis Results:")
    print(f"   - Has logs: {analysis['has_logs']}")
    print(f"   - Log count: {analysis['log_count']}")
    print(f"   - Is simulation: {analysis['is_simulation']}")
    print(f"   - Has Shannon: {analysis['has_shannon']}")
    print(f"   - Has process: {analysis['has_process']}")
    print(f"   - Has errors: {analysis['has_errors']}")
    print(f"   - Has completion: {analysis['has_completion']}")
    
    # Show recent logs
    print(f"\n5. Recent logs (last 10):")
    print("-" * 70)
    for log in logs[-10:]:
        level = log.get('level', 'info').upper()
        timestamp = format_timestamp(log.get('timestamp', ''))
        message = log.get('message', '')
        print(f"[{level}] {timestamp}: {message}")
    
    # Show Shannon logs if any
    if analysis['shannon_logs']:
        print(f"\n6. Shannon-related logs ({len(analysis['shannon_logs'])}):")
        print("-" * 70)
        for log in analysis['shannon_logs'][-5:]:
            level = log.get('level', 'info').upper()
            timestamp = format_timestamp(log.get('timestamp', ''))
            message = log.get('message', '')
            print(f"[{level}] {timestamp}: {message}")
    
    # Show errors if any
    if analysis['error_logs']:
        print(f"\n7. Error logs ({len(analysis['error_logs'])}):")
        print("-" * 70)
        for log in analysis['error_logs'][-5:]:
            level = log.get('level', 'info').upper()
            timestamp = format_timestamp(log.get('timestamp', ''))
            message = log.get('message', '')
            print(f"[{level}] {timestamp}: {message}")
    
    # Conclusion
    print(f"\n" + "=" * 70)
    print("CONCLUSION:")
    print("=" * 70)
    
    if analysis['is_simulation']:
        print("⚠️  PENTEST IS RUNNING IN SIMULATION MODE")
        print("   (Not using real Shannon/Claude API)")
    elif analysis['has_shannon'] and analysis['has_process']:
        print("✅ PENTEST APPEARS TO BE RUNNING WITH SHANNON")
        print("   (Real execution detected)")
    elif analysis['has_completion']:
        print("✅ PENTEST COMPLETED")
    elif analysis['has_errors']:
        print("❌ PENTEST HAS ERRORS")
        print("   Check error logs above")
    else:
        print("⚠️  UNCLEAR STATUS")
        print("   Check logs manually")
    
    print("=" * 70)

if __name__ == "__main__":
    main()

