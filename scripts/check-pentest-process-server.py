#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Check pentest process on server"""

import paramiko
import sys
import os

# Fix encoding
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')

SERVER_HOST = "5.129.235.52"
SERVER_USER = "root"
SERVER_PASSWORD = "cY7^kCCA_6uQ5S"
SERVER_PORT = 22
PENTEST_PID = "1672731"

def check_process():
    """Check if process is running"""
    print("=" * 80)
    print("CHECKING PENTEST PROCESS ON SERVER")
    print("=" * 80)
    
    try:
        # Connect to server
        print(f"\n1. Connecting to server {SERVER_HOST}...")
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(SERVER_HOST, port=SERVER_PORT, username=SERVER_USER, password=SERVER_PASSWORD, timeout=10)
        print("   ✅ Connected")
        
        # Check if process exists
        print(f"\n2. Checking process PID {PENTEST_PID}...")
        stdin, stdout, stderr = ssh.exec_command(f"ps -p {PENTEST_PID} -o pid,cmd,etime,stat 2>&1")
        process_info = stdout.read().decode('utf-8', errors='replace')
        print(process_info)
        
        if f"{PENTEST_PID}" in process_info and "defunct" not in process_info:
            print("   ✅ Process is running")
        else:
            print("   ❌ Process is NOT running (may have crashed)")
        
        # Check for node processes related to Shannon
        print(f"\n3. Checking for Shannon/node processes...")
        stdin, stdout, stderr = ssh.exec_command("ps aux | grep -E 'shannon|temporal/client' | grep -v grep")
        shannon_processes = stdout.read().decode('utf-8', errors='replace')
        if shannon_processes.strip():
            print(shannon_processes)
        else:
            print("   ⚠️  No Shannon processes found")
        
        # Check PM2 logs
        print(f"\n4. Checking PM2 logs (last 30 lines)...")
        stdin, stdout, stderr = ssh.exec_command("pm2 logs xaker-backend --lines 30 --nostream 2>&1 | tail -30")
        pm2_logs = stdout.read().decode('utf-8', errors='replace')
        print(pm2_logs[-2000:])  # Last 2000 chars
        
        # Check PM2 status
        print(f"\n5. Checking PM2 status...")
        stdin, stdout, stderr = ssh.exec_command("pm2 list")
        pm2_status = stdout.read().decode('utf-8', errors='replace')
        print(pm2_status)
        
        # Check Temporal connection
        print(f"\n6. Checking Temporal connection...")
        stdin, stdout, stderr = ssh.exec_command("netstat -tuln | grep 7233 || echo 'Temporal port 7233 not listening'")
        temporal_info = stdout.read().decode('utf-8', errors='replace')
        print(temporal_info)
        
        # Check pentest directory
        print(f"\n7. Checking pentest directory...")
        pentest_dir = "/opt/xaker/backend/pentests/cc8d4a16-a0bb-4570-b7b3-66fd8cb607c3"
        stdin, stdout, stderr = ssh.exec_command(f"ls -la {pentest_dir} 2>&1 | head -20")
        dir_info = stdout.read().decode('utf-8', errors='replace')
        print(dir_info)
        
        ssh.close()
        
        print("\n" + "=" * 80)
        print("ANALYSIS COMPLETE")
        print("=" * 80)
        
    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    check_process()

