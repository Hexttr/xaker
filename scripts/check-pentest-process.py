#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Check if pentest process is still running on server"""

import requests
import json
import sys
import os
from datetime import datetime, timezone

# Fix encoding for Windows
if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')

API_BASE = "https://pentest.red/api"
PENTEST_ID = "cc8d4a16-a0bb-4570-b7b3-66fd8cb607c3"

def get_time_diff(timestamp_str):
    """Get time difference from now"""
    try:
        dt = datetime.fromisoformat(timestamp_str.replace('Z', '+00:00'))
        now = datetime.now(timezone.utc)
        diff = now - dt
        return diff.total_seconds()
    except:
        return None

def main():
    print("=" * 80)
    print("CHECKING PENTEST STATUS")
    print("=" * 80)
    
    # Get pentest info
    try:
        pentest = requests.get(f"{API_BASE}/pentests/{PENTEST_ID}", timeout=10).json()
        print(f"\nPentest: {pentest.get('name', 'N/A')}")
        print(f"Status: {pentest.get('status', 'N/A')}")
        print(f"Target: {pentest.get('targetUrl', 'N/A')}")
        
        created = pentest.get('createdAt', '')
        if created:
            created_diff = get_time_diff(created)
            if created_diff:
                print(f"Created: {created} ({int(created_diff/60)} minutes ago)")
    except Exception as e:
        print(f"ERROR getting pentest info: {e}")
        return
    
    # Get logs
    try:
        logs = requests.get(f"{API_BASE}/pentests/{PENTEST_ID}/logs", timeout=10).json()
        print(f"\nTotal logs: {len(logs)}")
        
        if logs:
            last_log = logs[-1]
            last_time = last_log.get('timestamp', '')
            last_msg = last_log.get('message', '')
            last_level = last_log.get('level', '')
            
            print(f"\nLast log:")
            print(f"  Time: {last_time}")
            print(f"  Level: {last_level}")
            print(f"  Message: {last_msg[:200]}")
            
            # Check time difference
            time_diff = get_time_diff(last_time)
            if time_diff is not None:
                minutes_ago = int(time_diff / 60)
                seconds_ago = int(time_diff % 60)
                print(f"\n  ‚è±Ô∏è  Last log was {minutes_ago} minutes {seconds_ago} seconds ago")
                
                if time_diff > 300:  # 5 minutes
                    print(f"\n  ‚ö†Ô∏è  WARNING: No new logs for more than 5 minutes!")
                    print(f"  Possible issues:")
                    print(f"    - Process may have crashed")
                    print(f"    - Process may be stuck")
                    print(f"    - Network issues")
                    print(f"    - Temporal connection lost")
            
            # Show last 5 logs
            print(f"\nLast 5 logs:")
            print("-" * 80)
            for log in logs[-5:]:
                ts = log.get('timestamp', '')
                level = log.get('level', 'info').upper()
                msg = log.get('message', '')
                
                try:
                    dt = datetime.fromisoformat(ts.replace('Z', '+00:00'))
                    ts_str = dt.strftime('%H:%M:%S')
                except:
                    ts_str = ts
                
                print(f"[{ts_str}] [{level}] {msg[:150]}")
        
    except Exception as e:
        print(f"ERROR getting logs: {e}")
        return
    
    # Check for error patterns
    print(f"\n" + "=" * 80)
    print("ANALYSIS:")
    print("=" * 80)
    
    error_logs = [l for l in logs if l.get('level') == 'error']
    if error_logs:
        print(f"\n‚ùå Found {len(error_logs)} error logs:")
        for log in error_logs[-3:]:
            print(f"  - {log.get('message', '')[:200]}")
    else:
        print(f"\n‚úÖ No error logs found")
    
    # Check for completion
    completion_logs = [l for l in logs if '–∑–∞–≤–µ—Ä—à–µ–Ω' in l.get('message', '').lower() or 'completed' in l.get('message', '').lower()]
    if completion_logs:
        print(f"\n‚úÖ Found completion logs:")
        for log in completion_logs[-2:]:
            print(f"  - {log.get('message', '')[:200]}")
    
    # Check for process info
    process_logs = [l for l in logs if 'PID' in l.get('message', '') or '–ø—Ä–æ—Ü–µ—Å—Å' in l.get('message', '').lower()]
    if process_logs:
        print(f"\nüìã Process info:")
        for log in process_logs[-3:]:
            print(f"  - {log.get('message', '')[:200]}")
    
    # Check for Shannon activity
    shannon_logs = [l for l in logs if '[Shannon]' in l.get('message', '')]
    if shannon_logs:
        print(f"\nü§ñ Shannon activity: {len(shannon_logs)} logs")
        print(f"  Last Shannon log: {shannon_logs[-1].get('message', '')[:200]}")
    
    print("\n" + "=" * 80)
    print("RECOMMENDATION:")
    print("=" * 80)
    
    if time_diff and time_diff > 300:
        print("‚ö†Ô∏è  Process appears to be stuck or crashed")
        print("   Check server logs and PM2 status")
        print("   May need to restart the pentest")
    elif time_diff and time_diff < 60:
        print("‚úÖ Process is active (logs within last minute)")
    else:
        print("‚ö†Ô∏è  Process may be slow or waiting")
        print("   Continue monitoring...")

if __name__ == "__main__":
    main()

