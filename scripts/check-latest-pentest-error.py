#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Check latest pentest error"""

import paramiko
import sys
import requests
import json

if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')

SERVER_HOST = "5.129.235.52"
SERVER_USER = "root"
SERVER_PASSWORD = "cY7^kCCA_6uQ5S"
SERVER_PORT = 22

def check_error():
    """Check latest pentest error"""
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(SERVER_HOST, port=SERVER_PORT, username=SERVER_USER, password=SERVER_PASSWORD, timeout=10)
    
    print("=" * 80)
    print("CHECKING LATEST PENTEST ERROR")
    print("=" * 80)
    
    # Check worker logs
    print("\n1. Checking worker logs (last 50 lines)...")
    stdin, stdout, stderr = ssh.exec_command('docker logs shannon_worker_1 --tail=50 2>&1')
    worker_logs = stdout.read().decode('utf-8', errors='replace')
    
    # Look for errors
    error_lines = [line for line in worker_logs.split('\n') if 'error' in line.lower() or 'Error' in line or 'ERROR' in line or 'ENOENT' in line or 'spawn' in line.lower()]
    if error_lines:
        print("\n   ⚠️  Errors found in worker logs:")
        for err in error_lines[-20:]:
            print(f"   {err}")
    else:
        print("   ✅ No obvious errors in worker logs")
    
    # Check backend logs
    print("\n2. Checking backend logs...")
    stdin, stdout, stderr = ssh.exec_command('pm2 logs xaker-backend --lines 50 --nostream 2>&1')
    backend_logs = stdout.read().decode('utf-8', errors='replace')
    
    # Look for pentest errors
    pentest_errors = []
    for line in backend_logs.split('\n'):
        if 'ERROR' in line or 'error' in line.lower() or 'ENOENT' in line or 'spawn' in line.lower() or 'Shannon' in line:
            pentest_errors.append(line)
    
    if pentest_errors:
        print("\n   ⚠️  Errors found in backend logs:")
        for err in pentest_errors[-30:]:
            print(f"   {err}")
    
    # Check if worker is running
    print("\n3. Checking worker status...")
    stdin, stdout, stderr = ssh.exec_command('docker ps | grep shannon | grep worker')
    worker = stdout.read().decode('utf-8', errors='replace')
    if worker:
        container_id = worker.split()[0]
        print(f"   ✅ Worker is running: {container_id}")
        
        # Verify node symlink
        stdin, stdout, stderr = ssh.exec_command(f'docker exec {container_id} sh -c "ls -la /usr/local/bin/node && which node && /usr/local/bin/node --version"')
        verify = stdout.read().decode('utf-8', errors='replace')
        print(f"\n   Node verification:\n{verify}")
    else:
        print("   ⚠️  Worker is not running!")
    
    # Check recent pentest logs from API if possible
    print("\n4. Checking recent pentest activity...")
    stdin, stdout, stderr = ssh.exec_command('cd /opt/xaker/backend && find pentests -type f -name "*.log" -mmin -10 2>/dev/null | head -5')
    recent_logs = stdout.read().decode('utf-8', errors='replace')
    if recent_logs:
        print(f"   Recent log files:\n{recent_logs}")
        # Read one of them
        log_file = recent_logs.split('\n')[0].strip()
        if log_file:
            stdin, stdout, stderr = ssh.exec_command(f'cd /opt/xaker/backend && tail -50 "{log_file}" 2>&1')
            log_content = stdout.read().decode('utf-8', errors='replace')
            print(f"\n   Latest log content:\n{log_content[-1000:]}")
    
    ssh.close()
    
    print("\n" + "=" * 80)
    print("ERROR CHECK COMPLETE")
    print("=" * 80)
    
    # Show summary
    if error_lines or pentest_errors:
        print("\n⚠️  ERRORS DETECTED:")
        if 'ENOENT' in '\n'.join(error_lines + pentest_errors):
            print("   - spawn node ENOENT error still present")
        if 'spawn' in '\n'.join(error_lines + pentest_errors).lower():
            print("   - spawn error detected")
        print("\n   Check logs above for details")

if __name__ == "__main__":
    check_error()

