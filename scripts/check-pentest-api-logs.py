#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Check pentest logs via API"""

import requests
import json
import sys

if sys.platform == 'win32':
    import io
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')

API_URL = "https://pentest.red/api"

def check_api_logs():
    """Check pentest logs via API"""
    print("=" * 80)
    print("CHECKING PENTEST LOGS VIA API")
    print("=" * 80)
    
    try:
        # Get latest pentests
        response = requests.get(f"{API_URL}/pentests", timeout=10)
        if response.status_code == 200:
            pentests = response.json()
            if pentests:
                latest = pentests[0]
                pentest_id = latest.get('id')
                
                print(f"\n   Latest pentest ID: {pentest_id}")
                print(f"   Status: {latest.get('status')}")
                print(f"   Target: {latest.get('config', {}).get('targetUrl', 'N/A')}")
                
                # Get logs
                logs_response = requests.get(f"{API_URL}/pentests/{pentest_id}/logs", timeout=10)
                if logs_response.status_code == 200:
                    logs = logs_response.json()
                    print(f"\n   Logs ({len(logs)} entries):")
                    
                    # Show errors
                    errors = [log for log in logs if log.get('level') == 'error' or 'ERROR' in log.get('message', '')]
                    if errors:
                        print("\n   ‚ö†Ô∏è  ERRORS:")
                        for err in errors[-10:]:
                            print(f"   [{err.get('timestamp')}] {err.get('level')}: {err.get('message')}")
                    
                    # Show last 20 logs
                    print("\n   Last 20 logs:")
                    for log in logs[-20:]:
                        level = log.get('level', 'info')
                        message = log.get('message', '')
                        timestamp = log.get('timestamp', '')
                        emoji = 'üî¥' if level == 'error' else 'üü¢' if level == 'info' else 'üü°'
                        print(f"   {emoji} [{timestamp}] {message[:150]}")
                else:
                    print(f"   ‚ö†Ô∏è  Could not fetch logs: {logs_response.status_code}")
            else:
                print("   No pentests found")
        else:
            print(f"   ‚ö†Ô∏è  Could not fetch pentests: {response.status_code}")
    except Exception as e:
        print(f"   ‚ö†Ô∏è  Error: {e}")

if __name__ == "__main__":
    check_api_logs()

