#!/usr/bin/env python3
"""Diagnose pentest issues on server"""

import sys
import json
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

try:
    from server_manager_universal import UniversalServerManager
except ImportError:
    print("Cannot import server manager")
    sys.exit(1)

def diagnose():
    """Run diagnostics on server"""
    print("=" * 60)
    print("PENTEST DIAGNOSTICS")
    print("=" * 60)
    
    manager = UniversalServerManager()
    
    if not manager.connect():
        print("[ERROR] Cannot connect to server")
        return
    
    print(f"[OK] Connected using: {manager.connection_method}\n")
    
    # Check 1: Project directory
    print("1. Checking project directory...")
    exit_code, stdout, stderr = manager.execute("pwd")
    if exit_code == 0:
        print(f"   Current directory: {stdout.strip()}")
    else:
        print(f"   Error: {stderr}")
    
    # Check 2: Shannon directory
    print("\n2. Checking Shannon installation...")
    exit_code, stdout, stderr = manager.execute("ls -la /root/shannon 2>/dev/null || echo 'NOT FOUND'")
    print(f"   /root/shannon: {stdout.strip()[:100]}")
    
    exit_code, stdout, stderr = manager.execute("ls -la /root/xaker/../shannon 2>/dev/null || echo 'NOT FOUND'")
    print(f"   /root/xaker/../shannon: {stdout.strip()[:100]}")
    
    # Check 3: Backend directory and .env
    print("\n3. Checking backend configuration...")
    exit_code, stdout, stderr = manager.execute("cd /root/xaker/backend && pwd && ls -la .env 2>/dev/null || echo 'NO .env'")
    print(f"   Backend: {stdout.strip()[:200]}")
    
    # Check 4: ANTHROPIC_API_KEY
    print("\n4. Checking ANTHROPIC_API_KEY...")
    exit_code, stdout, stderr = manager.execute("cd /root/xaker/backend && grep -E '^ANTHROPIC_API_KEY=' .env 2>/dev/null | head -c 50 || echo 'NOT FOUND'")
    api_key_preview = stdout.strip()
    if api_key_preview and api_key_preview != "NOT FOUND":
        print(f"   [OK] API key found: {api_key_preview[:30]}...")
    else:
        print(f"   [ERROR] API key NOT FOUND")
    
    # Check 5: PM2 processes
    print("\n5. Checking PM2 processes...")
    exit_code, stdout, stderr = manager.execute("pm2 list 2>/dev/null || echo 'PM2 not running'")
    print(stdout.strip()[:500])
    
    # Check 6: Backend logs (last 20 lines)
    print("\n6. Checking backend logs...")
    exit_code, stdout, stderr = manager.execute("pm2 logs xaker-backend --lines 20 --nostream 2>/dev/null || echo 'No logs'")
    print(stdout.strip()[:1000])
    
    # Check 7: Shannon build status
    print("\n7. Checking Shannon build...")
    exit_code, stdout, stderr = manager.execute("ls -la /root/shannon/dist/temporal/client.js 2>/dev/null || echo 'NOT BUILT'")
    print(f"   Shannon client.js: {stdout.strip()[:100]}")
    
    # Check 8: Node version
    print("\n8. Checking Node.js...")
    exit_code, stdout, stderr = manager.execute("node --version && npm --version")
    print(f"   {stdout.strip()}")
    
    manager.disconnect()
    print("\n" + "=" * 60)
    print("DIAGNOSTICS COMPLETE")
    print("=" * 60)

if __name__ == "__main__":
    diagnose()

