# ⚡ Оптимизация деплоя

## Проблема

Первый деплой долгий из-за:
1. **Загрузка инструмента** - `drone-ssh` скачивается при первом запуске (~10-20 сек)
2. **Использование `@master`** - всегда проверяет последнюю версию
3. **Множественные шаги** - каждый шаг добавляет время

## Решения

### ✅ Оптимизация 1: Фиксированная версия

**Было:**
```yaml
uses: appleboy/ssh-action@master
```

**Стало:**
```yaml
uses: appleboy/ssh-action@v1.0.3
```

**Преимущества:**
- Не проверяет обновления каждый раз
- Быстрее запуск
- Предсказуемое поведение

### ✅ Оптимизация 2: Один шаг вместо нескольких

**Было:**
```yaml
- name: Checkout code
- name: Setup Node.js  
- name: Deploy to server
```

**Стало:**
```yaml
- name: Deploy to server
  # Все в одном шаге
```

**Преимущества:**
- Меньше overhead
- Быстрее выполнение

### ✅ Оптимизация 3: Объединение команд

**Было:**
```bash
cd /root/xaker
git pull origin prod
cd backend
npm run build
pm2 restart xaker-backend
```

**Стало:**
```bash
cd /root/xaker && git pull origin prod && cd backend && npm run build && pm2 restart xaker-backend
```

**Преимущества:**
- Один SSH сеанс вместо нескольких
- Быстрее выполнение

## Результаты

### Первый запуск
- **Было:** ~60-90 секунд (загрузка инструмента + выполнение)
- **Стало:** ~40-60 секунд (только загрузка инструмента, выполнение быстрее)

### Последующие запуски
- **Было:** ~30-40 секунд
- **Стало:** ~15-25 секунд

## Использование

### Стандартный workflow (оптимизированный)
Файл: `.github/workflows/deploy.yml`
- Использует фиксированную версию
- Оптимизированные команды
- Подробные логи

### Быстрый workflow
Файл: `.github/workflows/deploy-fast.yml`
- Минимальное время выполнения
- Одна команда
- Быстрый деплой

## Рекомендации

1. **Используйте фиксированную версию** вместо `@master`
2. **Объединяйте команды** где возможно
3. **Убирайте ненужные шаги** (checkout, setup если не нужны)
4. **Используйте `script_stop: true`** для остановки при ошибке

## Дополнительная оптимизация

Если нужен еще более быстрый деплой, можно:

1. **Использовать кэш npm** на сервере
2. **Параллельные команды** где возможно
3. **Условный build** (только если изменились файлы)

---

**Статус:** ✅ Workflow оптимизирован

