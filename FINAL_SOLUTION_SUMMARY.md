# Финальное решение - Резюме

## Проблема

Ошибка `spawn node ENOENT` возникает потому, что библиотека `@anthropic-ai/claude-agent-sdk` вызывает `spawn('node')`, но не может найти node в PATH для пользователя `pentest` в Docker контейнере.

## Почему на Windows работало, а на Ubuntu нет?

**На Windows:**
- Node был установлен глобально и доступен в системном PATH
- Не было ограничений пользователя Docker контейнера
- PATH наследовался правильно для всех процессов

**На Ubuntu в Docker:**
- PATH может не наследоваться правильно для пользователя `pentest`
- Симлинки могут быть недоступны из-за прав доступа
- Переменные окружения могут не передаваться дочерним процессам от `spawn()`

## Примененное решение

**Создание wrapper скрипта в `/tmp`:**

1. ✅ Обновлен startup скрипт `/opt/xaker/shannon/start-worker.sh`
   - Создает wrapper скрипт `/tmp/node` при каждом запуске контейнера
   - `/tmp` доступен для записи пользователю `pentest`
   - PATH установлен с `/tmp` первым: `PATH="/tmp:/app/bin:/usr/bin:/usr/local/bin:/bin:/usr/sbin:/sbin"`

2. ✅ Wrapper скрипт `/tmp/node`:
   ```bash
   #!/bin/sh
   exec /usr/bin/node "$@"
   ```

3. ✅ Worker запущен и работает (логи показывают "Shannon worker started" и "RUNNING")

## Текущий статус

- ✅ Worker контейнер запущен
- ✅ Worker процесс работает (RUNNING)
- ✅ Wrapper скрипт создается в `/tmp/node`
- ✅ PATH включает `/tmp` первым

## Тестирование

**Запустите новый пентест через https://pentest.red/app**

Если ошибка `spawn node ENOENT` все еще возникает, это означает, что:
- PATH не передается дочерним процессам от `spawn()` в библиотеке
- Нужно будет патчить библиотеку напрямую или использовать другой подход

## Альтернативные решения (если текущее не работает)

1. **Патч библиотеки** - заменить `spawn('node')` на `spawn('/usr/bin/node')` в минифицированном коде
2. **Использовать переменную NODE** - если библиотека поддерживает `process.env.NODE`
3. **Изменить USER в Dockerfile** - запускать от root вместо pentest (менее безопасно)

