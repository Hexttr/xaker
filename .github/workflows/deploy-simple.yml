name: Deploy to Production (Simple)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "=== Environment Info ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "PWD: $(pwd)"
          echo ""
          echo "=== Finding project ==="
          PROJECT_DIR=""
          
          # Try common locations
          for path in "/root/xaker" "$HOME/xaker" "/opt/xaker" "/var/www/xaker" "/home/xaker/xaker"; do
            if [ -d "$path" ]; then
              echo "Found: $path"
              PROJECT_DIR="$path"
              break
            fi
          done
          
          # If not found, search for xaker directory
          if [ -z "$PROJECT_DIR" ]; then
            echo "Searching for xaker directory..."
            FOUND=$(find /root /opt /var/www /home -type d -name "xaker" 2>/dev/null | head -1)
            if [ -n "$FOUND" ]; then
              echo "Found: $FOUND"
              PROJECT_DIR="$FOUND"
            fi
          fi
          
          # If still not found, check PM2 process working directory
          if [ -z "$PROJECT_DIR" ]; then
            echo "Checking PM2 process working directory..."
            PM2_CWD=$(pm2 jlist 2>/dev/null | grep -o '"cwd":"[^"]*' | grep -o '/[^"]*' | head -1)
            if [ -n "$PM2_CWD" ] && [ -d "$PM2_CWD" ]; then
              # Go up to project root if we're in backend
              if [ "$(basename $PM2_CWD)" = "backend" ]; then
                PROJECT_DIR=$(dirname "$PM2_CWD")
              else
                PROJECT_DIR="$PM2_CWD"
              fi
              echo "Found via PM2: $PROJECT_DIR"
            fi
          fi
          
          # If still not found, search for git repo with remote origin
          if [ -z "$PROJECT_DIR" ]; then
            echo "Searching for git repository with origin..."
            for gitdir in $(find /root /opt /var/www /home -type d -name ".git" 2>/dev/null); do
              if [ -f "$gitdir/config" ] && grep -q "Hexttr/xaker" "$gitdir/config" 2>/dev/null; then
                PROJECT_DIR=$(dirname "$gitdir")
                echo "Found git repo via origin: $PROJECT_DIR"
                break
              fi
            done
          fi
          
          if [ -z "$PROJECT_DIR" ]; then
            echo "ERROR: Project not found in common locations"
            echo "Checking /root contents:"
            ls -la /root/ | head -20
            echo ""
            echo "Checking /opt:"
            ls -la /opt/ 2>/dev/null | head -10
            echo ""
            echo "Checking /var/www:"
            ls -la /var/www/ 2>/dev/null | head -10
            exit 1
          fi
          
          cd "$PROJECT_DIR"
          echo "Current dir: $(pwd)"
          echo ""
          echo "=== Git pull ==="
          git pull origin prod
          echo ""
          echo "=== Build ==="
          cd backend
          npm run build
          echo ""
          echo "=== Restart ==="
          pm2 restart xaker-backend || pm2 start npm --name xaker-backend -- run start
          echo ""
          echo "=== Status ==="
          pm2 status xaker-backend

