name: Deploy to Production (Simple)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "=== Environment Info ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "PWD: $(pwd)"
          echo ""
          echo "=== Finding project ==="
          if [ -d "/root/xaker" ]; then
            echo "Found: /root/xaker"
            cd /root/xaker
          elif [ -d "$HOME/xaker" ]; then
            echo "Found: $HOME/xaker"
            cd $HOME/xaker
          else
            echo "ERROR: Project not found"
            echo "Checking /root:"
            ls -la /root/
            exit 1
          fi
          echo "Current dir: $(pwd)"
          echo ""
          echo "=== Git pull ==="
          git pull origin prod
          echo ""
          echo "=== Build ==="
          cd backend
          npm run build
          echo ""
          echo "=== Restart ==="
          pm2 restart xaker-backend || pm2 start npm --name xaker-backend -- run start
          echo ""
          echo "=== Status ==="
          pm2 status xaker-backend

