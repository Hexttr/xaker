name: Deploy to Production (Simple)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "=== Environment Info ==="
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "PWD: $(pwd)"
          echo ""
          echo "=== Finding project ==="
          PROJECT_DIR=""
          
          # Try common locations
          for path in "/root/xaker" "$HOME/xaker" "/opt/xaker" "/var/www/xaker" "/home/xaker/xaker"; do
            if [ -d "$path" ]; then
              echo "Found: $path"
              PROJECT_DIR="$path"
              break
            fi
          done
          
          # If not found, search for xaker directory
          if [ -z "$PROJECT_DIR" ]; then
            echo "Searching for xaker directory..."
            FOUND=$(find /root /opt /var/www /home -type d -name "xaker" 2>/dev/null | head -1)
            if [ -n "$FOUND" ]; then
              echo "Found: $FOUND"
              PROJECT_DIR="$FOUND"
            fi
          fi
          
          # If still not found, check if git repo exists
          if [ -z "$PROJECT_DIR" ]; then
            echo "Searching for git repository..."
            FOUND=$(find /root /opt /var/www /home -type d -name ".git" -path "*/xaker/.git" 2>/dev/null | head -1 | sed 's/\/\.git$//')
            if [ -n "$FOUND" ]; then
              echo "Found git repo: $FOUND"
              PROJECT_DIR="$FOUND"
            fi
          fi
          
          if [ -z "$PROJECT_DIR" ]; then
            echo "ERROR: Project not found in common locations"
            echo "Checking /root contents:"
            ls -la /root/ | head -20
            echo ""
            echo "Checking /opt:"
            ls -la /opt/ 2>/dev/null | head -10
            echo ""
            echo "Checking /var/www:"
            ls -la /var/www/ 2>/dev/null | head -10
            exit 1
          fi
          
          cd "$PROJECT_DIR"
          echo "Current dir: $(pwd)"
          echo ""
          echo "=== Git pull ==="
          git pull origin prod
          echo ""
          echo "=== Build ==="
          cd backend
          npm run build
          echo ""
          echo "=== Restart ==="
          pm2 restart xaker-backend || pm2 start npm --name xaker-backend -- run start
          echo ""
          echo "=== Status ==="
          pm2 status xaker-backend

