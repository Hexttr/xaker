name: Deploy to Production

on:
  push:
    branches:
      - prod
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Максимальное время выполнения
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3  # Фиксированная версия вместо master (быстрее)
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          echo "=== Starting deployment ==="
          
          # Find project directory - search in multiple locations
          PROJECT_DIR=""
          
          # Try common locations
          for path in "/root/xaker" "$HOME/xaker" "/opt/xaker" "/var/www/xaker"; do
            if [ -d "$path" ]; then
              PROJECT_DIR="$path"
              break
            fi
          done
          
          # If not found, search for xaker directory
          if [ -z "$PROJECT_DIR" ]; then
            FOUND=$(find /root /opt /var/www /home -maxdepth 3 -type d -name "xaker" 2>/dev/null | head -1)
            if [ -n "$FOUND" ]; then
              PROJECT_DIR="$FOUND"
            fi
          fi
          
          if [ -z "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found"
            echo "Searched in: /root, $HOME, /opt, /var/www"
            echo "Checking /root:"
            ls -la /root/ | head -10
            exit 1
          fi
          
          echo "Using project directory: $PROJECT_DIR"
          
          echo "[1/4] Pulling latest changes..."
          cd "$PROJECT_DIR"
          git pull origin prod
          
          echo "[2/4] Building backend..."
          cd "$PROJECT_DIR/backend"
          npm run build
          
          echo "[3/4] Restarting backend..."
          pm2 restart xaker-backend || (cd "$PROJECT_DIR/backend" && pm2 start npm --name xaker-backend -- run start)
          
          echo "[4/4] Checking status..."
          pm2 status xaker-backend
          
          echo "=== Deployment complete ==="

