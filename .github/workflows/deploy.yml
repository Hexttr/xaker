name: Deploy to Production

on:
  push:
    branches:
      - prod
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3  # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤–º–µ—Å—Ç–æ master (–±—ã—Å—Ç—Ä–µ–µ)
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          echo "üöÄ Starting deployment..."
          
          echo "üì• [1/4] Pulling latest changes..."
          cd /root/xaker || { echo "ERROR: /root/xaker not found"; exit 1; }
          git pull origin prod
          
          echo "üî® [2/4] Building backend..."
          cd backend || { echo "ERROR: backend directory not found"; exit 1; }
          npm run build
          
          echo "üîÑ [3/4] Restarting backend..."
          pm2 restart xaker-backend || (cd /root/xaker/backend && pm2 start npm --name xaker-backend -- run start)
          
          echo "‚úÖ [4/4] Checking status..."
          pm2 status xaker-backend
          
          echo "üéâ Deployment complete!"

