name: Deploy to Production

on:
  push:
    branches:
      - prod
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Максимальное время выполнения
    
    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3  # Фиксированная версия вместо master (быстрее)
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          set -e
          echo "=== Starting deployment ==="
          
          # Project directory - found via previous runs
          PROJECT_DIR="/opt/xaker"
          
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "ERROR: Project directory not found at $PROJECT_DIR"
            echo "Searching..."
            FOUND=$(find /opt /root /var/www /home -maxdepth 3 -type d -name "xaker" 2>/dev/null | head -1)
            if [ -n "$FOUND" ]; then
              PROJECT_DIR="$FOUND"
              echo "Found: $PROJECT_DIR"
            else
              echo "ERROR: Project directory not found"
              exit 1
            fi
          fi
          
          echo "Using project directory: $PROJECT_DIR"
          
          echo "[1/4] Pulling latest changes..."
          cd "$PROJECT_DIR"
          git config pull.rebase false
          git pull origin prod
          
          echo "[2/4] Building backend..."
          cd "$PROJECT_DIR/backend"
          npm run build
          
          echo "[3/4] Cleaning up duplicate PM2 processes..."
          pm2 delete xaker-backend 2>/dev/null || true
          
          echo "[3/4] Restarting backend..."
          cd "$PROJECT_DIR/backend"
          pm2 start npm --name xaker-backend -- run start
          
          echo "[4/4] Checking status..."
          pm2 status xaker-backend
          
          echo "=== Deployment complete ==="

