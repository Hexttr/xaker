name: Deploy to Production (Fast)

on:
  push:
    branches:
      - prod
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # Быстрый таймаут
    
    steps:
    - name: Deploy via SSH (single command)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          PROJECT_DIR="/root/xaker"
          [ ! -d "$PROJECT_DIR" ] && PROJECT_DIR="$HOME/xaker"
          [ ! -d "$PROJECT_DIR" ] && { echo "ERROR: Project not found"; ls -la /root/; exit 1; }
          cd "$PROJECT_DIR" && git pull origin prod && cd backend && npm run build && pm2 restart xaker-backend && pm2 status xaker-backend
        script_stop: true  # Остановка при ошибке

