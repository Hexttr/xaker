import { useState, memo, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { pentestApi, Pentest, CreatePentestRequest, Vulnerability } from '../services/api';
import { serviceApi, Service } from '../services/api';
import LogViewer from '../components/LogViewer';
import StatusBar from '../components/StatusBar';
import VulnerabilitiesList from '../components/VulnerabilitiesList';
import {
  FiPlus,
  FiPlay,
  FiSquare,
  FiTrash2,
  FiChevronDown,
  FiChevronUp,
  FiClock,
  FiTarget,
  FiAlertCircle,
  FiFileText,
  FiServer,
  FiLoader,
  FiShield,
  FiActivity,
  FiCheckCircle,
  FiSearch,
  FiGlobe,
} from 'react-icons/fi';

type StatusFilter = 'all' | 'running' | 'completed' | 'failed' | 'pending' | 'stopped';

// Компонент для отображения отдельного пентеста в виде карточки
const PentestCard = memo(function PentestCard({
  pentest,
  expanded,
  onToggleExpand,
  onStart,
  onStop,
  onDelete,
  startPending,
  stopPending,
  deletePending,
  getStatusColor,
  getStatusText,
  duration,
}: {
  pentest: Pentest;
  expanded: boolean;
  onToggleExpand: () => void;
  onStart: () => void;
  onStop: () => void;
  onDelete: () => void;
  startPending: boolean;
  stopPending: boolean;
  deletePending: boolean;
  getStatusColor: (status: Pentest['status']) => string;
  getStatusText: (status: Pentest['status']) => string;
  duration: string;
}) {
  // Загружаем логи - обновляем только для запущенных пентестов и реже
  const { data: logs = [], isLoading: logsLoading, isFetching: logsFetching } = useQuery({
    queryKey: ['pentest-logs', pentest.id],
    queryFn: () => pentestApi.getLogs(pentest.id).then(res => res.data),
    enabled: expanded,
    refetchInterval: expanded && pentest.status === 'running' ? 5000 : false,
    placeholderData: (previousData) => previousData ?? [],
    staleTime: 3000,
  });

  const { data: statusData } = useQuery({
    queryKey: ['pentest-status', pentest.id],
    queryFn: () => pentestApi.getStatus(pentest.id).then(res => res.data),
    enabled: pentest.status === 'running',
    refetchInterval: pentest.status === 'running' ? 5000 : false,
    staleTime: 3000,
  });

  // Получаем найденные уязвимости
  const { data: vulnerabilities = [] } = useQuery({
    queryKey: ['pentest-vulnerabilities', pentest.id],
    queryFn: () => pentestApi.getVulnerabilities(pentest.id).then(res => res.data),
    enabled: pentest.status === 'running' || pentest.status === 'completed',
    refetchInterval: pentest.status === 'running' ? 10000 : false,
    staleTime: pentest.status === 'completed' ? 5 * 60 * 1000 : 5000,
  });

  const currentStatus = statusData?.status || '⚙️ Выполнение пентеста...';
  const [isGeneratingReport, setIsGeneratingReport] = useState(false);

  const handleGenerateReport = async () => {
    setIsGeneratingReport(true);
    try {
      const blob = await pentestApi.generatePdfReport(pentest.id);
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `pentest-report-${pentest.id}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Ошибка при генерации PDF:', error);
      alert('Ошибка при генерации PDF отчета');
    } finally {
      setIsGeneratingReport(false);
    }
  };

  const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
  const highCount = vulnerabilities.filter(v => v.severity === 'high').length;
  const mediumCount = vulnerabilities.filter(v => v.severity === 'medium').length;
  const lowCount = vulnerabilities.filter(v => v.severity === 'low').length;

  return (
    <div className={`bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-4 sm:p-6 border border-gray-700 shadow-lg hover:shadow-xl transition-all duration-300 ease-in-out hover:border-gray-600 ${
      expanded ? 'col-span-full relative z-10' : ''
    }`}>
      {/* Header */}
      <div className="flex items-start justify-between mb-4">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-2 bg-blue-500/10 rounded-lg flex-shrink-0">
                  <FiShield className="w-5 h-5 text-blue-400" />
                </div>
                <div className="flex-1 min-w-0">
                  <h3 className="text-base sm:text-lg font-semibold text-white mb-1 truncate">
                    {(() => {
                      // Извлекаем название сервиса из имени пентеста
                      // Формат: "Пентест Astelventures - 20.01.2026, 2..."
                      const match = pentest.name.match(/Пентест\s+(.+?)\s*-/);
                      return match ? match[1] : pentest.name;
                    })()}
                  </h3>
              <div className="flex items-center gap-2 flex-wrap">
                <span
                  className={`px-2 py-0.5 rounded text-white text-xs font-medium whitespace-nowrap flex items-center gap-1 ${getStatusColor(pentest.status)}`}
                >
                  {pentest.status === 'failed' && <FiAlertCircle className="w-3 h-3" />}
                  {getStatusText(pentest.status)}
                </span>
                {pentest.status === 'running' && (
                  <StatusBar status={currentStatus} isRunning={true} />
                )}
              </div>
            </div>
          </div>
          <div className="flex items-center gap-1.5 text-gray-400 mb-2 text-sm">
            <FiGlobe className="w-4 h-4 flex-shrink-0" />
            <span className="font-mono text-xs break-all">{pentest.targetUrl}</span>
          </div>
        </div>
      </div>

      {/* Metrics */}
      <div className="grid grid-cols-2 gap-2 sm:gap-3 mb-4">
        <div className="bg-gray-800/50 rounded-lg p-2 sm:p-3 border border-gray-700 min-w-0 h-[100px] flex flex-col justify-between">
          <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
            <FiAlertCircle className="w-3 h-3 sm:w-4 sm:h-4 text-orange-400 flex-shrink-0" />
            <span className="text-xs text-gray-400 truncate">Уязвимости</span>
          </div>
          <div>
            <p className="text-lg sm:text-xl font-bold text-white">{vulnerabilities.length}</p>
            {vulnerabilities.length > 0 ? (
              <div className="text-xs text-gray-500 mt-1">
                <span className="text-red-400">{criticalCount}</span> /{' '}
                <span className="text-orange-400">{highCount}</span> /{' '}
                <span className="text-yellow-400">{mediumCount}</span> /{' '}
                <span className="text-yellow-300">{lowCount}</span>
              </div>
            ) : (
              <div className="text-xs text-gray-500 mt-1 h-[16px]"></div>
            )}
          </div>
        </div>
        <div className="bg-gray-800/50 rounded-lg p-2 sm:p-3 border border-gray-700 min-w-0 h-[100px] flex flex-col justify-between">
          <div className="flex items-center gap-1.5 sm:gap-2 mb-1">
            <FiClock className="w-3 h-3 sm:w-4 sm:h-4 text-blue-400 flex-shrink-0" />
            <span className="text-xs text-gray-400 truncate">Время</span>
          </div>
          <div>
            <p className="text-lg sm:text-xl font-bold text-white">{duration}</p>
            <div className="text-xs text-gray-500 mt-1 h-[16px]"></div>
          </div>
        </div>
      </div>

      {/* Dates */}
      <div className="flex flex-wrap gap-2 text-xs text-gray-500 mb-4">
        <span className="flex items-center gap-1">
          <FiClock className="w-3 h-3" />
          Создан: {new Date(pentest.createdAt).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}
        </span>
        {pentest.startedAt && (
          <span className="flex items-center gap-1">
            <FiClock className="w-3 h-3" />
            Запущен: {new Date(pentest.startedAt).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}
          </span>
        )}
        {pentest.completedAt && (
          <span className="flex items-center gap-1">
            <FiCheckCircle className="w-3 h-3" />
            Завершен: {new Date(pentest.completedAt).toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}
          </span>
        )}
      </div>

      {/* Actions */}
      <div className="pt-4 border-t border-gray-700">
        <div className="flex flex-wrap gap-2">
          {pentest.status === 'pending' && (
            <button
              onClick={onStart}
              disabled={startPending}
              className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-xs sm:text-sm font-medium disabled:opacity-50 transition-colors duration-200 flex items-center justify-center gap-1.5"
            >
              <FiPlay className="w-3 h-3 sm:w-4 sm:h-4" />
              Запустить
            </button>
          )}
          {pentest.status === 'running' && (
            <button
              onClick={onStop}
              disabled={stopPending}
              className="flex-1 bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs sm:text-sm font-medium disabled:opacity-50 transition-colors duration-200 flex items-center justify-center gap-1.5 animate-pulse"
            >
              <FiSquare className="w-3 h-3 sm:w-4 sm:h-4" />
              Остановить
            </button>
          )}
          <button
            onClick={onToggleExpand}
            className="flex-1 bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-3 py-2 rounded-lg text-xs sm:text-sm font-medium transition-all duration-200 flex items-center justify-center gap-1.5"
          >
            {expanded ? (
              <>
                <FiChevronUp className="w-3 h-3 sm:w-4 sm:h-4" />
                Скрыть
              </>
            ) : (
              <>
                <FiChevronDown className="w-3 h-3 sm:w-4 sm:h-4" />
                Логи
              </>
            )}
          </button>
          {(pentest.status === 'completed' || pentest.status === 'failed') && (
            <button
              onClick={handleGenerateReport}
              disabled={isGeneratingReport || pentest.status === 'failed'}
              className={`flex-1 px-3 py-2 rounded-lg text-xs sm:text-sm font-medium transition-all duration-200 flex items-center justify-center gap-1.5 ${
                pentest.status === 'failed'
                  ? 'bg-gray-600 text-gray-400 cursor-not-allowed opacity-50'
                  : 'bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 disabled:opacity-50 disabled:cursor-not-allowed text-white'
              }`}
            >
              {isGeneratingReport ? (
                <>
                  <FiLoader className="w-3 h-3 sm:w-4 sm:h-4 animate-spin" />
                  Генерирую...
                </>
              ) : (
                <>
                  <FiFileText className="w-3 h-3 sm:w-4 sm:h-4" />
                  Отчет
                </>
              )}
            </button>
          )}
          <button
            onClick={onDelete}
            disabled={deletePending}
            className="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-xs sm:text-sm font-medium disabled:opacity-50 transition-colors duration-200 flex items-center justify-center gap-1.5 border border-gray-600"
          >
            <FiTrash2 className="w-3 h-3 sm:w-4 sm:h-4" />
            Удалить
          </button>
        </div>
      </div>

      {/* Expanded Content */}
      {expanded && (
        <div className="mt-6 pt-6 border-t border-gray-700 transition-opacity duration-300">
          <div className="mb-6">
            <h4 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              <FiAlertCircle className="w-4 h-4 text-orange-400" />
              Найденные уязвимости
            </h4>
            <VulnerabilitiesList vulnerabilities={vulnerabilities} />
          </div>
          <div>
            <h4 className="text-sm font-semibold text-white mb-3 flex items-center gap-2">
              <FiFileText className="w-4 h-4 text-blue-400" />
              Логи выполнения
            </h4>
            <div className="bg-gray-800/50 rounded-lg border border-gray-700 p-4">
              <LogViewer
                logs={logs}
                autoScroll={true}
                maxHeight="600px"
                isLoading={logsLoading || logsFetching}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
});

export default function Pentests() {
  const [selectedServiceId, setSelectedServiceId] = useState<string>('');
  const [statusFilter, setStatusFilter] = useState<StatusFilter>('all');
  const [searchQuery, setSearchQuery] = useState<string>('');
  const [expandedPentestId, setExpandedPentestId] = useState<string | null>(null);
  const queryClient = useQueryClient();

  const { data: services = [] } = useQuery({
    queryKey: ['services'],
    queryFn: () => serviceApi.getAll().then(res => res.data),
  });

  const { data: pentests = [], isLoading } = useQuery({
    queryKey: ['pentests'],
    queryFn: () => pentestApi.getAll().then(res => res.data),
    refetchInterval: 5000,
    staleTime: 3000,
  });

  // Фильтруем пентесты по выбранному сервису для метрик
  const filteredPentestsForMetrics = useMemo(() => {
    if (!selectedServiceId) return pentests;
    const selectedService = services.find(s => s.id === selectedServiceId);
    if (!selectedService) return pentests;
    return pentests.filter(p => p.targetUrl === selectedService.url);
  }, [pentests, services, selectedServiceId]);

  // Вычисляем метрики на основе отфильтрованных пентестов
  const metrics = useMemo(() => {
    const total = filteredPentestsForMetrics.length;
    const running = filteredPentestsForMetrics.filter(p => p.status === 'running').length;
    const completed = filteredPentestsForMetrics.filter(p => p.status === 'completed').length;
    const failed = filteredPentestsForMetrics.filter(p => p.status === 'failed').length;
    const pending = filteredPentestsForMetrics.filter(p => p.status === 'pending').length;
    const stopped = filteredPentestsForMetrics.filter(p => p.status === 'stopped').length;

    return {
      total,
      running,
      completed,
      failed,
      pending,
      stopped,
    };
  }, [filteredPentestsForMetrics]);

  // Фильтруем и группируем пентесты
  const { filteredAndGroupedPentests, groupedByService } = useMemo(() => {
    let filtered = pentests;

    // Фильтр по сервису
    if (selectedServiceId) {
      const selectedService = services.find(s => s.id === selectedServiceId);
      if (selectedService) {
        filtered = filtered.filter(p => p.targetUrl === selectedService.url);
      }
    }

    // Фильтр по статусу
    if (statusFilter !== 'all') {
      filtered = filtered.filter(p => p.status === statusFilter);
    }

    // Поиск
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(
        p =>
          p.name.toLowerCase().includes(query) ||
          p.targetUrl.toLowerCase().includes(query) ||
          p.id.toLowerCase().includes(query)
      );
    }

    // Группировка по сервисам
    const grouped: Record<string, { service: Service; pentests: Pentest[] }> = {};
    filtered.forEach(pentest => {
      const service = services.find(s => s.url === pentest.targetUrl);
      if (service) {
        if (!grouped[service.id]) {
          grouped[service.id] = { service, pentests: [] };
        }
        grouped[service.id].pentests.push(pentest);
      } else {
        // Если сервис не найден, создаем группу "Неизвестный сервис"
        if (!grouped['unknown']) {
          grouped['unknown'] = {
            service: { id: 'unknown', name: 'Неизвестный сервис', url: pentest.targetUrl, createdAt: '', updatedAt: '' },
            pentests: [],
          };
        }
        grouped['unknown'].pentests.push(pentest);
      }
    });

    return {
      filteredAndGroupedPentests: grouped,
      groupedByService: Object.keys(grouped).length > 1,
    };
  }, [pentests, services, selectedServiceId, statusFilter, searchQuery]);

  // Вычисляем длительность пентеста
  const getDuration = (pentest: Pentest): string => {
    if (!pentest.startedAt) return '-';
    const start = new Date(pentest.startedAt);
    const end = pentest.completedAt ? new Date(pentest.completedAt) : new Date();
    const diff = end.getTime() - start.getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    if (hours > 0) {
      return `${hours}ч ${minutes}м`;
    }
    return `${minutes}м`;
  };

  const createAndStartMutation = useMutation({
    mutationFn: async (data: CreatePentestRequest) => {
      const newPentest = await pentestApi.create(data).then(res => res.data);
      if (newPentest && newPentest.id) {
        await pentestApi.start(newPentest.id);
      }
      return newPentest;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pentests'] });
    },
  });

  const startMutation = useMutation({
    mutationFn: (id: string) => pentestApi.start(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pentests'] });
    },
  });

  const stopMutation = useMutation({
    mutationFn: (id: string) => pentestApi.stop(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pentests'] });
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id: string) => pentestApi.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['pentests'] });
    },
  });

  const getStatusColor = (status: Pentest['status']) => {
    switch (status) {
      case 'running':
        return 'bg-blue-500';
      case 'completed':
        return 'bg-green-500';
      case 'failed':
        return 'bg-red-500';
      case 'stopped':
        return 'bg-gray-500';
      default:
        return 'bg-yellow-500';
    }
  };

  const getStatusText = (status: Pentest['status']) => {
    switch (status) {
      case 'running':
        return 'Запущен';
      case 'completed':
        return 'Завершен';
      case 'failed':
        return 'Ошибка';
      case 'stopped':
        return 'Остановлен';
      default:
        return 'Ожидание';
    }
  };

  const handleStartPentest = () => {
    if (!selectedServiceId) {
      alert('Выберите сервис для запуска пентеста');
      return;
    }
    const selectedService = services.find(s => s.id === selectedServiceId);
    if (!selectedService) {
      alert('Сервис не найден');
      return;
    }
    const pentestName = `Пентест ${selectedService.name} - ${new Date().toLocaleString('ru-RU', { dateStyle: 'short', timeStyle: 'short' })}`;
    createAndStartMutation.mutate({
      name: pentestName,
      config: {
        targetUrl: selectedService.url,
      },
    });
  };

  return (
    <div className="min-h-screen bg-black">
      <div className="p-4 md:p-6">
        <div className="max-w-7xl mx-auto space-y-6">
          {/* Header */}
          <div className="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
            <div>
              <h1 className="text-2xl md:text-3xl font-bold text-white mb-1">Пентесты</h1>
              <p className="text-sm text-gray-400">Управление и мониторинг пентестов</p>
            </div>
            <div className="flex gap-2">
              <select
                value={selectedServiceId}
                onChange={(e) => setSelectedServiceId(e.target.value)}
                className="px-4 py-2 bg-gray-900 border border-gray-700 text-white rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
              >
                <option value="">Все сервисы</option>
                {services.map((service) => (
                  <option key={service.id} value={service.id}>
                    {service.name}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {/* Metrics Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-blue-500/10 rounded-lg">
                  <FiShield className="w-6 h-6 text-blue-400" />
                </div>
                <span className="text-3xl font-bold text-white">{metrics.total}</span>
              </div>
              <h3 className="text-sm font-medium text-gray-400 mb-1">Всего пентестов</h3>
              <p className="text-xs text-gray-500">Все пентесты</p>
            </div>

            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-green-500/10 rounded-lg">
                  <FiActivity className="w-6 h-6 text-green-400" />
                </div>
                <div className="text-right">
                  <span className="text-3xl font-bold text-white block">{metrics.running}</span>
                  <div className="text-xs text-gray-500 mt-1">
                    <span className="text-green-400">{metrics.completed}</span> /{' '}
                    <span className="text-red-400">{metrics.failed}</span>
                  </div>
                </div>
              </div>
              <h3 className="text-sm font-medium text-gray-400 mb-1">Активные</h3>
              <p className="text-xs text-gray-500">Запущено / Завершено / Ошибок</p>
            </div>

            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-yellow-500/10 rounded-lg">
                  <FiAlertCircle className="w-6 h-6 text-yellow-400" />
                </div>
                <span className="text-3xl font-bold text-white">{metrics.pending}</span>
              </div>
              <h3 className="text-sm font-medium text-gray-400 mb-1">Ожидание</h3>
              <p className="text-xs text-gray-500">В очереди</p>
            </div>

            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
              <div className="flex items-center justify-between mb-4">
                <div className="p-3 bg-purple-500/10 rounded-lg">
                  <FiServer className="w-6 h-6 text-purple-400" />
                </div>
                <span className="text-3xl font-bold text-white">{services.length}</span>
              </div>
              <h3 className="text-sm font-medium text-gray-400 mb-1">Сервисов</h3>
              <p className="text-xs text-gray-500">Отслеживается</p>
            </div>
          </div>

          {/* Filters and Search */}
          <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
            <div className="flex flex-col md:flex-row gap-4">
              {/* Search */}
              <div className="flex-1">
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <FiSearch className="inline w-4 h-4 mr-2" />
                  Поиск
                </label>
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Поиск по названию, URL или ID..."
                  className="w-full px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                />
              </div>

              {/* Service Selection */}
              <div className="flex-1">
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <FiServer className="inline w-4 h-4 mr-2" />
                  Сервис
                </label>
                <select
                  value={selectedServiceId}
                  onChange={(e) => setSelectedServiceId(e.target.value)}
                  className="w-full px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500"
                >
                  <option value="">Все сервисы</option>
                  {services.map((service) => (
                    <option key={service.id} value={service.id}>
                      {service.name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Start Button */}
              <div className="flex items-end">
                <button
                  onClick={handleStartPentest}
                  disabled={createAndStartMutation.isPending || !selectedServiceId}
                  className="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white px-6 py-2 rounded-lg text-sm font-medium disabled:opacity-50 transition-all duration-200 flex items-center justify-center gap-2"
                >
                  <FiPlay className="w-4 h-4" />
                  {createAndStartMutation.isPending ? 'Запуск...' : 'Запустить пентест'}
                </button>
              </div>
            </div>

            {/* Status Tabs */}
            <div className="mt-4 flex flex-wrap gap-2 border-t border-gray-700 pt-4">
              <button
                onClick={() => setStatusFilter('all')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                  statusFilter === 'all'
                    ? 'bg-red-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'
                }`}
              >
                Все ({metrics.total})
              </button>
              <button
                onClick={() => setStatusFilter('running')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                  statusFilter === 'running'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'
                }`}
              >
                Запущенные ({metrics.running})
              </button>
              <button
                onClick={() => setStatusFilter('completed')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                  statusFilter === 'completed'
                    ? 'bg-green-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'
                }`}
              >
                Завершенные ({metrics.completed})
              </button>
              <button
                onClick={() => setStatusFilter('failed')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                  statusFilter === 'failed'
                    ? 'bg-red-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'
                }`}
              >
                Ошибки ({metrics.failed})
              </button>
              <button
                onClick={() => setStatusFilter('pending')}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 ${
                  statusFilter === 'pending'
                    ? 'bg-yellow-600 text-white'
                    : 'bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-white'
                }`}
              >
                Ожидание ({metrics.pending})
              </button>
            </div>
          </div>

          {/* Pentests Grid */}
          {isLoading ? (
            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-8 border border-gray-700 shadow-lg text-center">
              <p className="text-gray-400">Загрузка...</p>
            </div>
          ) : Object.keys(filteredAndGroupedPentests).length === 0 ? (
            <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-8 border border-gray-700 shadow-lg text-center">
              <FiShield className="w-12 h-12 text-gray-600 mx-auto mb-3" />
              <p className="text-gray-400 mb-2">Пентесты не найдены</p>
              <p className="text-sm text-gray-500">Измените фильтры или создайте новый пентест</p>
            </div>
          ) : (
            <div className="space-y-6">
              {Object.entries(filteredAndGroupedPentests).map(([serviceId, { service, pentests: servicePentests }]) => (
                <div key={serviceId}>
                  {groupedByService && (
                    <div className="mb-4">
                      <h2 className="text-lg font-semibold text-white mb-2 flex items-center gap-2">
                        <FiServer className="w-5 h-5 text-blue-400" />
                        {service.name}
                        <span className="text-sm text-gray-400 font-normal">
                          ({servicePentests.length} {servicePentests.length === 1 ? 'пентест' : 'пентестов'})
                        </span>
                      </h2>
                      <p className="text-sm text-gray-500 font-mono mb-4">{service.url}</p>
                    </div>
                  )}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {(() => {
                      // Перемещаем раскрытую карточку в начало списка
                      const sortedPentests = [...servicePentests].sort((a, b) => {
                        const aExpanded = expandedPentestId === a.id;
                        const bExpanded = expandedPentestId === b.id;
                        if (aExpanded && !bExpanded) return -1;
                        if (!aExpanded && bExpanded) return 1;
                        return 0;
                      });
                      
                      return sortedPentests.map((pentest) => (
                        <PentestCard
                          key={pentest.id}
                          pentest={pentest}
                          expanded={expandedPentestId === pentest.id}
                          onToggleExpand={() =>
                            setExpandedPentestId(expandedPentestId === pentest.id ? null : pentest.id)
                          }
                          onStart={() => startMutation.mutate(pentest.id)}
                          onStop={() => stopMutation.mutate(pentest.id)}
                          onDelete={() => {
                            if (confirm('Удалить этот пентест?')) {
                              deleteMutation.mutate(pentest.id);
                            }
                          }}
                          startPending={startMutation.isPending}
                          stopPending={stopMutation.isPending}
                          deletePending={deleteMutation.isPending}
                          getStatusColor={getStatusColor}
                          getStatusText={getStatusText}
                          duration={getDuration(pentest)}
                        />
                      ));
                    })()}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
