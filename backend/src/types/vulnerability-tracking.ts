/**
 * Типы для отслеживания динамики уязвимостей между пентестами
 */

export interface VulnerabilityFingerprint {
  /** ID уязвимости из Shannon (AUTH-VULN-01, etc.) */
  id: string;
  /** Тип уязвимости (Authentication, Authorization, XSS, etc.) */
  type: string;
  /** Расположение (URL/эндпоинт) */
  location: string;
  /** Название уязвимости */
  title: string;
  /** Критичность */
  severity: 'critical' | 'high' | 'medium' | 'low';
  /** Хеш для быстрого сравнения */
  hash?: string;
}

export type VulnerabilityStatus = 
  | 'new'              // Новая уязвимость (впервые найдена)
  | 'fixed'            // Исправлена (была в предыдущем пентесте, не найдена в текущем)
  | 'remaining'        // Осталась (была в предыдущем, найдена и в текущем)
  | 'regressed'        // Регрессия (была исправлена, но появилась снова)
  | 'partially_fixed'  // Частично исправлена (severity снизилась)
  | 'worsened';        // Ухудшилась (severity повысилась)

export interface VulnerabilityHistoryEntry {
  /** ID пентеста */
  pentestId: string;
  /** Название пентеста */
  pentestName: string;
  /** Дата пентеста */
  pentestDate: string;
  /** Статус в этом пентесте */
  status: VulnerabilityStatus;
  /** Критичность в этом пентесте */
  severity: 'critical' | 'high' | 'medium' | 'low';
  /** Найдена ли в этом пентесте */
  found: boolean;
  /** Детали уязвимости */
  details?: {
    description: string;
    location: string;
    proofOfConcept?: string;
  };
}

export interface VulnerabilityTracking {
  /** Уникальный идентификатор для группировки */
  normalizedId: string;
  /** Отпечаток уязвимости */
  fingerprint: VulnerabilityFingerprint;
  /** История по пентестам */
  history: VulnerabilityHistoryEntry[];
  /** Агрегированные метрики */
  metrics: {
    /** Дата первого обнаружения */
    firstFound: string;
    /** Дата последнего обнаружения */
    lastFound?: string;
    /** Дата исправления */
    fixedDate?: string;
    /** Сколько раз найдена */
    timesFound: number;
    /** Сколько раз исправлена */
    timesFixed: number;
    /** Текущий статус */
    currentStatus: VulnerabilityStatus;
    /** Текущая критичность */
    currentSeverity: 'critical' | 'high' | 'medium' | 'low';
  };
}

export interface VulnerabilityComparison {
  /** Исправленные уязвимости */
  fixed: VulnerabilityTracking[];
  /** Оставшиеся уязвимости */
  remaining: VulnerabilityTracking[];
  /** Новые уязвимости */
  new: VulnerabilityTracking[];
  /** Частично исправленные */
  partiallyFixed: Array<{
    previous: VulnerabilityTracking;
    current: VulnerabilityTracking;
  }>;
  /** Ухудшившиеся */
  worsened: Array<{
    previous: VulnerabilityTracking;
    current: VulnerabilityTracking;
  }>;
  /** Регрессии */
  regressed: VulnerabilityTracking[];
  /** Метрики сравнения */
  metrics: {
    totalFixed: number;
    totalRemaining: number;
    totalNew: number;
    fixRate: number; // Процент исправления
    improvementRate: number; // Процент улучшения
  };
}

export interface PentestGroup {
  /** Нормализованный URL цели */
  normalizedUrl: string;
  /** Оригинальный URL */
  targetUrl: string;
  /** Все пентесты этой цели */
  pentests: Array<{
    id: string;
    name: string;
    targetUrl: string;
    createdAt: string;
    completedAt?: string;
    status: string;
  }>;
  /** Последний пентест */
  latestPentest?: {
    id: string;
    date: string;
  };
  /** Первый пентест */
  firstPentest?: {
    id: string;
    date: string;
  };
  /** История всех уязвимостей */
  vulnerabilityHistory: VulnerabilityTracking[];
  /** Метрики группы */
  metrics: {
    totalVulnerabilities: number;
    fixedVulnerabilities: number;
    remainingVulnerabilities: number;
    newVulnerabilities: number;
    securityScore: number; // 0-10
    improvementRate: number; // Процент улучшения
  };
}

export interface ProgressTimeline {
  /** Дата */
  date: string;
  /** ID пентеста */
  pentestId: string;
  /** Название пентеста */
  pentestName: string;
  /** Количество уязвимостей */
  vulnerabilityCount: number;
  /** По критичности */
  bySeverity: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  /** Балл безопасности */
  securityScore: number;
}

