import { v4 as uuidv4 } from 'uuid';
import { Pentest, PentestConfig, PentestLog } from '../types/pentest';

class PentestService {
  private pentests: Map<string, Pentest> = new Map();
  private logs: Map<string, PentestLog[]> = new Map();

  createPentest(name: string, config: PentestConfig): Pentest {
    const pentest: Pentest = {
      id: uuidv4(),
      name,
      targetUrl: config.targetUrl,
      status: 'pending',
      config,
      createdAt: new Date().toISOString(),
    };

    this.pentests.set(pentest.id, pentest);
    this.logs.set(pentest.id, []);

    this.addLog(pentest.id, 'info', `Пентест "${name}" создан`);

    return pentest;
  }

  getPentest(id: string): Pentest | undefined {
    return this.pentests.get(id);
  }

  getAllPentests(): Pentest[] {
    return Array.from(this.pentests.values()).sort(
      (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
    );
  }

  updatePentestStatus(id: string, status: Pentest['status']): boolean {
    const pentest = this.pentests.get(id);
    if (!pentest) return false;

    pentest.status = status;
    
    if (status === 'running' && !pentest.startedAt) {
      pentest.startedAt = new Date().toISOString();
      this.addLog(id, 'info', 'Пентест запущен');
    } else if (status === 'completed' || status === 'failed' || status === 'stopped') {
      pentest.completedAt = new Date().toISOString();
      this.addLog(id, status === 'completed' ? 'success' : 'info', `Пентест ${status === 'completed' ? 'завершен' : status === 'failed' ? 'завершился с ошибкой' : 'остановлен'}`);
    }

    return true;
  }

  deletePentest(id: string): boolean {
    const deleted = this.pentests.delete(id);
    this.logs.delete(id);
    return deleted;
  }

  addLog(pentestId: string, level: PentestLog['level'], message: string): void {
    const log: PentestLog = {
      id: uuidv4(),
      pentestId,
      level,
      message,
      timestamp: new Date().toISOString(),
    };

    const pentestLogs = this.logs.get(pentestId) || [];
    pentestLogs.push(log);
    this.logs.set(pentestId, pentestLogs);
  }

  getLogs(pentestId: string): PentestLog[] {
    return this.logs.get(pentestId) || [];
  }
}

export const pentestService = new PentestService();

