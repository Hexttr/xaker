import { VulnerabilityFingerprint } from '../types/vulnerability-tracking';
import { vulnerabilityExtractorService } from './vulnerability-extractor.service';
import { statSync } from 'fs';
import { join } from 'path';

/**
 * Кеш для результатов извлечения уязвимостей
 */
class VulnerabilityExtractorCacheService {
  private cache: Map<string, { 
    vulnerabilities: VulnerabilityFingerprint[], 
    lastModified: number 
  }> = new Map();

  /**
   * Получить уязвимости с кешированием
   */
  getVulnerabilities(pentestId: string): VulnerabilityFingerprint[] {
    const deliverablesDir = join(process.cwd(), 'pentests', pentestId, 'deliverables');
    const cacheKey = pentestId;
    
    // Проверяем, есть ли кеш
    const cached = this.cache.get(cacheKey);
    if (cached) {
      // Проверяем, не изменились ли файлы
      try {
        const comprehensiveReport = join(deliverablesDir, 'comprehensive_security_assessment_report.md');
        const stats = statSync(comprehensiveReport);
        
        // Если файл не изменился, возвращаем из кеша
        if (stats.mtimeMs <= cached.lastModified) {
          return cached.vulnerabilities;
        }
      } catch {
        // Файл не существует или ошибка - используем кеш если есть
        return cached.vulnerabilities;
      }
    }
    
    // Извлекаем уязвимости
    const vulnerabilities = vulnerabilityExtractorService.extractVulnerabilitiesFromPentest(pentestId);
    
    // Сохраняем в кеш
    try {
      const comprehensiveReport = join(deliverablesDir, 'comprehensive_security_assessment_report.md');
      const stats = statSync(comprehensiveReport);
      this.cache.set(cacheKey, {
        vulnerabilities,
        lastModified: stats.mtimeMs
      });
    } catch {
      // Если не удалось получить время модификации, все равно кешируем
      this.cache.set(cacheKey, {
        vulnerabilities,
        lastModified: Date.now()
      });
    }
    
    return vulnerabilities;
  }

  /**
   * Очистить кеш для конкретного пентеста
   */
  clearCache(pentestId: string): void {
    this.cache.delete(pentestId);
  }

  /**
   * Очистить весь кеш
   */
  clearAllCache(): void {
    this.cache.clear();
  }
}

export const vulnerabilityExtractorCacheService = new VulnerabilityExtractorCacheService();

