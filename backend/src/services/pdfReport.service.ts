import { join } from 'path';
import { existsSync, readFileSync, readdirSync, statSync, writeFileSync, mkdirSync } from 'fs';
import { marked } from 'marked';
import puppeteer from 'puppeteer';
import { pentestService } from './pentest.service';
import { query } from '@anthropic-ai/claude-agent-sdk';
import { MiroMindService } from './miromind.service';

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –æ—Ç—á–µ—Ç–æ–≤
 */
class PdfReportService {
  private readonly REPORTS_DIR = join(process.cwd(), 'reports');
  private readonly LOGS_DIR = join(process.cwd(), 'report-logs');
  private currentLogs: string[] = [];
  private useMiroMind: boolean = false;
  private miromindService: MiroMindService | null = null;

  constructor() {
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    if (!existsSync(this.REPORTS_DIR)) {
      mkdirSync(this.REPORTS_DIR, { recursive: true });
    }
    // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
    if (!existsSync(this.LOGS_DIR)) {
      mkdirSync(this.LOGS_DIR, { recursive: true });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å MiroMind
    this.useMiroMind = process.env.USE_MIROMIND === 'true';
    if (this.useMiroMind) {
      try {
        this.miromindService = new MiroMindService();
        console.log('‚úÖ MiroMind –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤');
      } catch (error) {
        console.warn('‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å MiroMind:', error);
        this.useMiroMind = false;
      }
    }
  }

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª
   */
  private log(message: string): void {
    const timestamp = new Date().toISOString();
    const logMessage = `[${timestamp}] ${message}`;
    this.currentLogs.push(logMessage);
    console.log(message);
  }

  private logError(message: string, error?: any): void {
    const timestamp = new Date().toISOString();
    let errorMessage = `[${timestamp}] ‚ùå ${message}`;
    if (error) {
      errorMessage += `\n   –¢–∏–ø: ${error?.constructor?.name || 'Unknown'}`;
      errorMessage += `\n   –°–æ–æ–±—â–µ–Ω–∏–µ: ${error?.message || String(error)}`;
      if (error?.stack) {
        errorMessage += `\n   Stack: ${error.stack.split('\n').slice(0, 5).join('\n')}`;
      }
    }
    this.currentLogs.push(errorMessage);
    console.error(message, error);
  }

  private logWarn(message: string): void {
    const timestamp = new Date().toISOString();
    const logMessage = `[${timestamp}] ‚ö†Ô∏è  ${message}`;
    this.currentLogs.push(logMessage);
    console.warn(message);
  }


  /**
   * –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
   */
  private saveLogsToFile(pentestId: string): string {
    const filename = `report-generation-${pentestId}-${Date.now()}.log`;
    const filepath = join(this.LOGS_DIR, filename);
    const content = this.currentLogs.join('\n');
    writeFileSync(filepath, content, 'utf-8');
    return filepath;
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
   */
  private clearLogs(): void {
    this.currentLogs = [];
  }

  /**
   * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á–µ—Ç –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç–∞
   */
  async generatePdfReport(pentestId: string): Promise<string> {
    // –û—á–∏—â–∞–µ–º –ª–æ–≥–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    this.clearLogs();
    this.log(`\n${'='.repeat(80)}`);
    this.log(`üöÄ [PDF REPORT] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç–∞ ${pentestId}`);
    this.log(`${'='.repeat(80)}\n`);

    try {
      const pentest = pentestService.getPentest(pentestId);
      if (!pentest) {
        throw new Error('–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      }

      // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞
      const pentestDir = join(process.cwd(), 'pentests', pentestId);
      const deliverablesDir = join(pentestDir, 'deliverables');

      if (!existsSync(deliverablesDir)) {
        throw new Error('–ü–∞–ø–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      }

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Markdown –æ—Ç—á–µ—Ç —Å –ø—Ä–æ–º–ø—Ç–æ–º
      const markdownReport = await this.generateMarkdownReport(pentestId, pentest, deliverablesDir);

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ HTML
      const htmlReport = await this.markdownToHtml(markdownReport, pentest);

      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HTML –≤ PDF
      const pdfPath = await this.htmlToPdf(htmlReport, pentestId);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª
      const logPath = this.saveLogsToFile(pentestId);
      this.log(`\n‚úÖ [PDF REPORT] PDF –æ—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${pdfPath}`);
      this.log(`üìã [PDF REPORT] –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${logPath}`);

      return pdfPath;
    } catch (error: any) {
      this.logError('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –æ—Ç—á–µ—Ç–∞', error);
      const logPath = this.saveLogsToFile(pentestId);
      this.log(`üìã [PDF REPORT] –õ–æ–≥–∏ –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${logPath}`);
      throw error;
    }
  }

  /**
   * –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Markdown –æ—Ç—á–µ—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
   */
  private async generateMarkdownReport(
    pentestId: string,
    pentest: any,
    deliverablesDir: string
  ): Promise<string> {
    this.log(`\n${'='.repeat(80)}`);
    this.log(`üìù [GENERATE REPORT] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Markdown –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç–∞ ${pentestId}`);
    this.log(`   –¶–µ–ª—å: ${pentest.targetUrl}`);
    this.log(`   –ü–∞–ø–∫–∞ deliverables: ${deliverablesDir}`);
    this.log(`${'='.repeat(80)}\n`);
    
    // –ß–∏—Ç–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ deliverables
    const files = this.getAllReportFiles(deliverablesDir);
    this.log(`üìÇ [GENERATE REPORT] –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: ${files.length}`);
    if (files.length > 0) {
      this.log(`   –§–∞–π–ª—ã: ${files.map(f => f.name).join(', ')}`);
    }

    // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤
    let allContent = '';
    for (const file of files) {
      try {
        const content = readFileSync(file.path, 'utf-8');
        allContent += `\n\n## ${file.name}\n\n${content}\n\n`;
        this.log(`   ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω —Ñ–∞–π–ª: ${file.name} (${content.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
      } catch (error) {
        this.logError(`   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ ${file.path}`, error);
      }
    }
    this.log(`üìä [GENERATE REPORT] –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: ${allContent.length} —Å–∏–º–≤–æ–ª–æ–≤`);

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç —Å –Ω–æ–≤—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
    this.log(`\nüöÄ [GENERATE REPORT] –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Å–Ω–æ–≤–Ω–æ–≥–æ AI-–æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ generateAttackChain...`);
    const startTime = Date.now();
    let aiReport = await this.generateAttackChain(allContent, pentest.targetUrl, deliverablesDir);
    const duration = Date.now() - startTime;
    this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${duration}ms`);
    this.log(`   üìè –†–∞–∑–º–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ AI-–æ—Ç—á–µ—Ç–∞: ${aiReport.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(aiReport.length / 1000)}K)`);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (AI –∏–ª–∏ fallback)
    this.log(`\nüßπ [GENERATE REPORT] –ü—Ä–∏–º–µ–Ω—è—é –æ—á–∏—Å—Ç–∫—É –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤...`);
    const beforeCleanLength = aiReport.length;
    aiReport = this.cleanReportFromEnglishSections(aiReport);
    this.log(`   üìè –î–æ –æ—á–∏—Å—Ç–∫–∏: ${beforeCleanLength} —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ—Å–ª–µ: ${aiReport.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    this.log(`\nüîó [GENERATE REPORT] –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–∞–∑–¥–µ–ª "–¶–µ–ø–æ—á–∫–∞ –≤–∑–ª–æ–º–∞"...`);
    const attackChainStartTime = Date.now();
    const attackChain = await this.generateAttackChainSection(allContent, pentest.targetUrl, deliverablesDir);
    this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏: ${Date.now() - attackChainStartTime}ms`);
    this.log(`   üìè –†–∞–∑–º–µ—Ä —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞: ${attackChain.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    this.log(`\nüìä [GENERATE REPORT] –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ä–∞–∑–¥–µ–ª "–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑"...`);
    const analysisStartTime = Date.now();
    const detailedAnalysis = await this.generateDetailedAnalysis(allContent, pentest.targetUrl, deliverablesDir);
    this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞: ${Date.now() - analysisStartTime}ms`);
    this.log(`   üìè –†–∞–∑–º–µ—Ä –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: ${detailedAnalysis.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    
    const report = `# üõ°Ô∏è –û—Ç—á–µ—Ç –æ –ø–µ–Ω—Ç–µ—Å—Ç–µ: ${pentest.targetUrl}

**AI Penetration Testing Platform | Pentest.red**

---

## üìã –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **–¶–µ–ª—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** | ${pentest.targetUrl} |
| **–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ–Ω—Ç–µ—Å—Ç–∞** | ${pentest.name} |
| **–°—Ç–∞—Ç—É—Å** | ${pentest.status === 'completed' ? '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω' : pentest.status} |
| **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è** | ${new Date(pentest.createdAt).toLocaleString('ru-RU')} |
| **–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞** | ${pentest.startedAt ? new Date(pentest.startedAt).toLocaleString('ru-RU') : '–ù–µ –Ω–∞—á–∞—Ç'} |
| **–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è** | ${pentest.completedAt ? new Date(pentest.completedAt).toLocaleString('ru-RU') : '–ù–µ –∑–∞–≤–µ—Ä—à–µ–Ω'} |
| **ID –ø–µ–Ω—Ç–µ—Å—Ç–∞** | \`${pentestId}\` |

---

## üîó –¶–µ–ø–æ—á–∫–∞ –≤–∑–ª–æ–º–∞

${attackChain}

---

${aiReport}

---

## üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

${detailedAnalysis}

---

## ‚öñÔ∏è –ü—Ä–∞–≤–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–î–∞–Ω–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ. –í—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.

---

**¬© 2026 Pentest.red | Enterprise Security Platform**

*–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞: ${new Date().toLocaleString('ru-RU')}*

*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ AI Penetration Testing Platform*
`;

    // –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É –∫–æ –≤—Å–µ–º—É —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –æ—Ç—á–µ—Ç—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
    this.log(`\nüßπ [GENERATE REPORT] –ü—Ä–∏–º–µ–Ω—è—é —Ñ–∏–Ω–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É –æ—Ç—á–µ—Ç–∞...`);
    const beforeFinalCleanLength = report.length;
    const finalReport = this.cleanFinalReport(report);
    this.log(`   üìè –î–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏: ${beforeFinalCleanLength} —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ—Å–ª–µ: ${finalReport.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    this.log(`\n‚úÖ [GENERATE REPORT] Markdown –æ—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!\n`);
    return finalReport;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ –∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –æ—Ç—á–µ—Ç–æ–≤
   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç AI (Claude) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞
   */
  private async generateAttackChain(content: string, targetUrl: string, deliverablesDir: string): Promise<string> {
    this.log(`\n${'‚îÄ'.repeat(80)}`);
    this.log(`ü§ñ [AI REPORT] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ Claude AI`);
    this.log(`${'‚îÄ'.repeat(80)}`);
    
    const apiKey = process.env.ANTHROPIC_API_KEY;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É API –∫–ª—é—á–∞
    if (!apiKey) {
      this.logWarn(`‚ö†Ô∏è  [AI REPORT] ANTHROPIC_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ process.env`);
      this.logWarn(`   ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback —Ä–µ–∂–∏–º (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π)`);
    } else if (apiKey === 'your_api_key_here') {
      this.logWarn(`‚ö†Ô∏è  [AI REPORT] ANTHROPIC_API_KEY –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "${apiKey}"`);
      this.logWarn(`   ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback —Ä–µ–∂–∏–º (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π)`);
    } else {
      this.log(`‚úÖ [AI REPORT] ANTHROPIC_API_KEY –Ω–∞–π–¥–µ–Ω (–¥–ª–∏–Ω–∞: ${apiKey.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
      this.log(`   –ü—Ä–µ—Ñ–∏–∫—Å –∫–ª—é—á–∞: ${apiKey.substring(0, 10)}...`);
      this.log(`   ‚Üí –ü—ã—Ç–∞—é—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Claude AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞`);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ MiroMind
    this.log(`\nüîç [AI REPORT] –ü—Ä–æ–≤–µ—Ä–∫–∞ MiroMind:`);
    this.log(`   USE_MIROMIND –∏–∑ env: ${process.env.USE_MIROMIND}`);
    this.log(`   this.useMiroMind: ${this.useMiroMind}`);
    this.log(`   this.miromindService —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${!!this.miromindService}`);
    
    const miromindAvailable = this.useMiroMind && this.miromindService 
      ? await this.miromindService.isServiceAvailable() 
      : false;
    
    this.log(`   miromindAvailable: ${miromindAvailable}`);
    
    if (miromindAvailable) {
      try {
        this.log(`üß† [AI REPORT] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞`);
        const aiReport = await this.generateAttackChainWithMiroMind(content, targetUrl, deliverablesDir);
        this.log(`‚úÖ [AI REPORT] MiroMind —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç—á–µ—Ç`);
        this.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç—á–µ—Ç–∞: ${aiReport.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(aiReport.length / 1000)}K)`);
        this.log(`   üìä –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–≤: ${aiReport.split(/\s+/).length}`);
        return aiReport;
      } catch (error: any) {
        this.logError(`\n‚ùå [AI REPORT] –û–®–ò–ë–ö–ê –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ MiroMind:`, error);
        this.logWarn(`\n‚ö†Ô∏è  [AI REPORT] –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ Claude API...`);
        // Fallback –Ω–∞ Claude
      }
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å API –∫–ª—é—á, –∏—Å–ø–æ–ª—å–∑—É–µ–º AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏
    if (apiKey && apiKey !== 'your_api_key_here') {
      try {
        this.log(`üöÄ [AI REPORT] –í—ã–∑—ã–≤–∞—é generateAttackChainWithAI()...`);
        const aiReport = await this.generateAttackChainWithAI(content, targetUrl, deliverablesDir, apiKey);
        this.log(`‚úÖ [AI REPORT] Claude AI —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç—á–µ—Ç`);
        this.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç—á–µ—Ç–∞: ${aiReport.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(aiReport.length / 1000)}K)`);
        this.log(`   üìä –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–≤: ${aiReport.split(/\s+/).length}`);
        return aiReport;
      } catch (error: any) {
        this.logError(`\n‚ùå [AI REPORT] –û–®–ò–ë–ö–ê –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ Claude AI:`, error);
        this.logWarn(`\n‚ö†Ô∏è  [AI REPORT] –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback —Ä–µ–∂–∏–º (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π)`);
        // Fallback –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥
      }
    } else {
      this.logWarn(`‚ö†Ô∏è  [AI REPORT] Claude AI –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ API –∫–ª—é—á–∞`);
    }
    
    // Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ AI
    this.log(`\nüìã [AI REPORT] –ò—Å–ø–æ–ª—å–∑—É—é fallback —Ä–µ–∂–∏–º - –ø—Ä–æ—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π`);
    const fallbackResult = this.generateAttackChainSimple(content, targetUrl);
    this.log(`   üìè –†–∞–∑–º–µ—Ä fallback –æ—Ç—á–µ—Ç–∞: ${fallbackResult.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    return fallbackResult;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç —á–µ—Ä–µ–∑ MiroMind
   */
  private async generateAttackChainWithMiroMind(
    content: string,
    targetUrl: string,
    deliverablesDir: string
  ): Promise<string> {
    if (!this.miromindService) {
      throw new Error('MiroMind —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    this.log(`üß† [AI REPORT] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞`);
    
    // –ß–∏—Ç–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const files = this.getAllReportFiles(deliverablesDir);
    let allFilesContent = '';
    for (const file of files) {
      try {
        const fileContent = readFileSync(file.path, 'utf-8');
        allFilesContent += `\n\n=== ${file.name} ===\n\n${fileContent}\n\n`;
      } catch (error) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è
      }
    }

    const prompt = `–¢–´ –î–û–õ–ñ–ï–ù –û–¢–í–ï–ß–ê–¢–¨ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –í–ï–°–¨ –û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!

–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –∏ —Å–æ–∑–¥–∞–π –ü–û–õ–ù–´–ô –ü–û–î–†–û–ë–ù–´–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${targetUrl}.

üö®üö®üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –Ø–ó–´–ö –ò –°–¢–†–£–ö–¢–£–†–ê üö®üö®üö®
1. –í–ï–°–¨ –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ù–ê–ü–ò–°–ê–ù –°–¢–†–û–ì–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï - –ù–ò–ö–ê–ö–ò–• –ê–ù–ì–õ–ò–ô–°–ö–ò–• –¢–ï–ö–°–¢–û–í!
2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –ó–ê–ì–û–õ–û–í–ö–ò - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ï!
3. –ù–ï –ü–ò–®–ò "Executive Summary" - –ü–ò–®–ò "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ"
4. –ù–ï –ü–ò–®–ò "Critical Vulnerabilities" - –ü–ò–®–ò "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏"
5. –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –°–û–î–ï–†–ñ–ê–¢–¨ –í–°–ï 7 –†–ê–ó–î–ï–õ–û–í, –£–ö–ê–ó–ê–ù–ù–´–• –ù–ò–ñ–ï - –ù–ï –¢–û–õ–¨–ö–û –¶–ï–ü–û–ß–ö–£ –í–ó–õ–û–ú–ê!
6. –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ü–û–õ–ù–´–ú –ò –ü–û–î–†–û–ë–ù–´–ú - –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô –ü–û –†–ê–ó–ú–ï–†–£!
7. –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤, –∫–æ–º–∞–Ω–¥—ã, –∫–æ–¥ –∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
8. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–∞–π–ª—ã, –Ω–æ –æ–ø–∏—Å—ã–≤–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –°–í–û–ò–ú–ò –°–õ–û–í–ê–ú–ò, –ü–û–î–†–û–ë–ù–û
9. –í–∫–ª—é—á–∞–π –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï, –í–´–°–û–ö–ò–ï –∏ –°–†–ï–î–ù–ò–ï —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∏–µ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)
10. –ö–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ü–û–î–†–û–ë–ù–´–ú - –º–∏–Ω–∏–º—É–º 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
11. –ù–ï –¥—É–±–ª–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
12. –í–∫–ª—é—á–∞–π –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, –Ω–æ –Ω–µ –∫–æ–ø–∏—Ä—É–π –∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é - –æ–ø–∏—Å—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
13. –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–û–õ–ù–´–ú –ò –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–´–ú!

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û –Ø–ó–´–ö–£:
1. –í–°–ï –†–ê–ó–î–ï–õ–´ –û–¢–ß–ï–¢–ê –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê–ü–ò–°–ê–ù–´ –°–¢–†–û–ì–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï
2. –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ê–ù–ì–õ–ò–ô–°–ö–ò–ï –ó–ê–ì–û–õ–û–í–ö–ò - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ï!
3. –í–°–ï –¢–ï–ö–°–¢–´, –û–ü–ò–°–ê–ù–ò–Ø, –í–´–í–û–î–´ - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!

–°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê (—Å–æ–∑–¥–∞–π –í–°–ï —ç—Ç–∏ 7 —Ä–∞–∑–¥–µ–ª–æ–≤, –ë–ï–ó –ü–û–í–¢–û–†–û–í, –í–°–ï –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï):

### 1. –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
   - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–µ–Ω—Ç–µ—Å—Ç–∞
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
   - –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

### 2. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
   - –û–±—ä–µ–º –∏ –≥–ª—É–±–∏–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–µ–Ω—Ç–µ—Å—Ç–∞

### 3. –ü–û–î–†–û–ë–ù–ê–Ø –¶–ï–ü–û–ß–ö–ê –í–ó–õ–û–ú–ê
   –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–∑–¥–∞–π –ü–û–î–†–û–ë–ù–£–Æ –ø–æ—à–∞–≥–æ–≤—É—é —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π:
   - –ù–∞—á–Ω–∏ —Å –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –∞—Ç–∞–∫–∏ (reconnaissance, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
   - –û–ø–∏—à–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –∞—Ç–∞–∫–∏ –ø–æ–¥—Ä–æ–±–Ω–æ (–∫–∞–∫ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—è–∑–≤–∏–º–æ—Å—Ç–∏)
   - –ü–æ–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ ‚Üí —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è ‚Üí —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π ‚Üí –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —É–∫–∞–∂–∏: —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫, –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç, –∫–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–∞–µ—Ç
   - –¶–µ–ø–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏—á–Ω–æ–π –∏ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–π
   - –ú–∏–Ω–∏–º—É–º 5-7 —à–∞–≥–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ –≤–∑–ª–æ–º–∞
   - –ö–∞–∂–¥—ã–π —à–∞–≥ –æ–ø–∏—à–∏ –ü–û–î–†–û–ë–ù–û - –º–∏–Ω–∏–º—É–º 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
   - –í–°–ï –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!

### 4. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
   –î–ª—è –ö–ê–ñ–î–û–ô –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π/–≤—ã—Å–æ–∫–æ–π/—Å—Ä–µ–¥–Ω–µ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ü–û–î–†–û–ë–ù–û (–í–°–ï –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –ú–ò–ù–ò–ú–£–ú 3-5 –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô –ù–ê –ü–£–ù–ö–¢):
   - **–ù–∞–∑–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏** (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–∫–æ–±–∫–∞—Ö)
   - **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø/–í–´–°–û–ö–ê–Ø/–°–†–ï–î–ù–Ø–Ø –∏–ª–∏ CRITICAL/HIGH/MEDIUM)
   - **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ** (URL –∏–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç)
   - **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π - —á—Ç–æ –Ω–µ —Ç–∞–∫, –ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞, –∫–∞–∫ —ç—Ç–æ –º–æ–∂–Ω–æ —ç–∫—Å–ø–ª—É–∞—Ç–∏—Ä–æ–≤–∞—Ç—å) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   - **–ë–∏–∑–Ω–µ—Å-–≤–ª–∏—è–Ω–∏–µ** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –∫–∞–∫–æ–π —É—â–µ—Ä–± –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–Ω–µ—Å–µ–Ω) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** (3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π - –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å, —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   
   –í–ê–ñ–ù–û: –í–∫–ª—é—á–∞–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ, –≤—ã—Å–æ–∫–∏–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏. –ù–∏–∑–∫–∏–µ –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.

### 5. –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –ø–æ –±–∏–∑–Ω–µ—Å-–∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É—â–µ—Ä–± –æ—Ç —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú

### 6. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π
   - –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) - –ù–ê –†–£–°–°–ö–û–ú
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º—É —É–ª—É—á—à–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - Best practices –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú

### 7. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
   - –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–µ–Ω—Ç–µ—Å—Ç–∞ - –ù–ê –†–£–°–°–ö–û–ú
   - –û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É - –ù–ê –†–£–°–°–ö–û–ú

–§–ê–ô–õ–´ –° –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú–ò –ü–ï–ù–¢–ï–°–¢–ê (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ù–ï –∫–æ–ø–∏—Ä—É–π –≤ –æ—Ç—á–µ—Ç):
${allFilesContent.substring(0, 200000)}

üí° –í–ê–ñ–ù–û - –ü–û–õ–ù–û–¢–ê –û–¢–ß–ï–¢–ê:
- –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ü–û–õ–ù–´–ú –ò –ü–û–î–†–û–ë–ù–´–ú - –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô –ü–û –†–ê–ó–ú–ï–†–£!
- –ì–ï–ù–ï–†–ò–†–£–ô –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–õ–ò–ù–ù–´–ô –ò –ü–û–î–†–û–ë–ù–´–ô –û–¢–ß–ï–¢ - –ù–ï –≠–ö–û–ù–û–ú–¨ –ù–ê –°–õ–û–í–ê–•!
- –ú–∏–Ω–∏–º—É–º 10000-15000 —Å–ª–æ–≤ –≤ –æ—Ç—á–µ—Ç–µ (–Ω–µ –º–µ–Ω–µ–µ 50000-80000 —Å–∏–º–≤–æ–ª–æ–≤)
- –í–∫–ª—é—á–∞–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ, –≤—ã—Å–æ–∫–∏–µ –∏ —Å—Ä–µ–¥–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- –ö–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ü–û–î–†–û–ë–ù–´–ú - –º–∏–Ω–∏–º—É–º 5-10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –∫–∞–∂–¥—É—é —É—è–∑–≤–∏–º–æ—Å—Ç—å
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—Å—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
- –í–∫–ª—é—á–∞–π –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ò –í–°–ï 7 –†–ê–ó–î–ï–õ–û–í: –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ, –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è, –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –≤–∑–ª–æ–º–∞, –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤, –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
- –†–ê–°–®–ò–†–Ø–ô –ö–ê–ñ–î–´–ô –†–ê–ó–î–ï–õ - –¥–æ–±–∞–≤–ª—è–π –¥–µ—Ç–∞–ª–∏, –ø—Ä–∏–º–µ—Ä—ã, –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –ù–ï –ë–û–ô–°–Ø –ë–´–¢–¨ –ú–ù–û–ì–û–°–õ–û–í–ù–´–ú - –ß–ï–ú –ë–û–õ–¨–®–ï –î–ï–¢–ê–õ–ï–ô, –¢–ï–ú –õ–£–ß–®–ï!`;

    try {
      const requestStartTime = Date.now();
      this.log(`üöÄ [AI REPORT] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ MiroMind...`);
      this.log(`   –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      const fullResponse = await this.miromindService.generateText(prompt, 64000);
      
      const requestDuration = Date.now() - requestStartTime;
      this.log(`\nüìä [AI REPORT] –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω:`);
      this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${requestDuration}ms (${Math.round(requestDuration / 1000)} —Å–µ–∫)`);
      this.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(fullResponse.length / 1000)}K)`);
      
      // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
      this.log(`\nüßπ [AI REPORT] –ü—Ä–∏–º–µ–Ω—è—é –æ—á–∏—Å—Ç–∫—É –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤...`);
      const cleaned = this.cleanReportFromEnglishSections(fullResponse);
      this.log(`   üìè –î–æ –æ—á–∏—Å—Ç–∫–∏: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ—Å–ª–µ: ${cleaned.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      return cleaned;
    } catch (error: any) {
      this.logError(`\n‚ùå [AI REPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ —á–µ—Ä–µ–∑ MiroMind:`, error);
      throw error;
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Claude AI
   */
  private async generateAttackChainWithAI(
    content: string,
    targetUrl: string,
    deliverablesDir: string,
    apiKey: string
  ): Promise<string> {
    // –ß–∏—Ç–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const files = this.getAllReportFiles(deliverablesDir);
    let allFilesContent = '';
    for (const file of files) {
      try {
        const fileContent = readFileSync(file.path, 'utf-8');
        allFilesContent += `\n\n=== ${file.name} ===\n\n${fileContent}\n\n`;
      } catch (error) {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —á—Ç–µ–Ω–∏—è
      }
    }

    const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø–µ–Ω—Ç–µ—Å—Ç–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤—Å–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –∏ —Å–æ–∑–¥–∞–π –ö–†–ê–¢–ö–ò–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${targetUrl}.

üö®üö®üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–¢–†–û–ì–û–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –û–ë–™–ï–ú–ê üö®üö®üö®
1. –û–¢–ß–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ö–†–ê–¢–ö–ò–ú –ù–ê 10-15 –õ–ò–°–¢–û–í (–ù–ï –ë–û–õ–ï–ï 3000 –°–õ–û–í, –ù–ï –ë–û–õ–ï–ï 15000 –°–ò–ú–í–û–õ–û–í)
2. –ù–ò –í –ö–û–ï–ú –°–õ–£–ß–ê–ï –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤, –∫–æ–º–∞–Ω–¥—ã, –∫–æ–¥ –∏–ª–∏ –¥–ª–∏–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
3. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ–∞–π–ª—ã, –Ω–æ –æ–ø–∏—Å—ã–≤–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –°–í–û–ò–ú–ò –°–õ–û–í–ê–ú–ò, –ö–†–ê–¢–ö–û (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
4. –í–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –∏ –í–´–°–û–ö–ò–ï —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (—Å—Ä–µ–¥–Ω–∏–µ –∏ –Ω–∏–∑–∫–∏–µ –ü–†–û–ü–£–°–ö–ê–ô)
5. –ö–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ - –ú–ê–ö–°–ò–ú–£–ú 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –±–æ–ª—å—à–µ
6. –ù–ï –¥—É–±–ª–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
7. –£–±–∏—Ä–∞–π –í–°–ï –ª–∏—à–Ω–∏–µ –¥–µ—Ç–∞–ª–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –∫–æ–¥—ã, –∫–æ–º–∞–Ω–¥—ã - –æ—Å—Ç–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –°–£–¢–¨
8. –ï—Å–ª–∏ –æ—Ç—á–µ—Ç –ø–æ–ª—É—á–∞–µ—Ç—Å—è –±–æ–ª—å—à–µ 15000 —Å–∏–º–≤–æ–ª–æ–≤ - –û–ë–†–ï–ñ–¨ –µ–≥–æ –¥–æ —ç—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –í–°–ï –†–ê–ó–î–ï–õ–´ –û–¢–ß–ï–¢–ê –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê–ü–ò–°–ê–ù–´ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï


–°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê (—Å–æ–∑–¥–∞–π –¢–û–õ–¨–ö–û —ç—Ç–∏ 6 —Ä–∞–∑–¥–µ–ª–æ–≤, –ë–ï–ó –ü–û–í–¢–û–†–û–í):

### 1. Executive Summary (–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ)
   - –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–µ–Ω—Ç–µ—Å—Ç–∞
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
   - –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)

### 2. –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
   - –û–±—ä–µ–º –∏ –≥–ª—É–±–∏–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø–µ–Ω—Ç–µ—Å—Ç–∞

### 3. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
   –î–ª—è –ö–ê–ñ–î–û–ô –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π/–≤—ã—Å–æ–∫–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ö–†–ê–¢–ö–û (–í–°–ï –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï, –ú–ê–ö–°–ò–ú–£–ú 2-3 –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ù–ê –ü–£–ù–ö–¢):
   - **–ù–∞–∑–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏** (–∫—Ä–∞—Ç–∫–æ, –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤ —Å–∫–æ–±–∫–∞—Ö)
   - **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å** (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø/–í–´–°–û–ö–ê–Ø –∏–ª–∏ CRITICAL/HIGH - –≤–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –∏—Ö)
   - **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ** (–∫–æ—Ä–æ—Ç–∫–æ - URL –∏–ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç)
   - **–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - —á—Ç–æ –Ω–µ —Ç–∞–∫ –∏ –ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   - **–ë–∏–∑–Ω–µ—Å-–≤–ª–∏—è–Ω–∏–µ** (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ - –∫–∞–∫–æ–π —É—â–µ—Ä–±) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   - **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è - –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å) - –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú
   
   –í–ê–ñ–ù–û: –í–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –≤—ã—Å–æ–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏. –°—Ä–µ–¥–Ω–∏–µ –∏ –Ω–∏–∑–∫–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞.

### 4. –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
   - –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –ø–æ –±–∏–∑–Ω–µ—Å-–∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —É—â–µ—Ä–± –æ—Ç —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú
   - –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú

### 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π
   - –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (–ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) - –ù–ê –†–£–°–°–ö–û–ú
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–º—É —É–ª—É—á—à–µ–Ω–∏—é –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - Best practices –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–¥–æ–±–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –ù–ê –†–£–°–°–ö–û–ú

### 6. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
   - –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø–µ–Ω—Ç–µ—Å—Ç–∞ - –ù–ê –†–£–°–°–ö–û–ú
   - –û—Ü–µ–Ω–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –ù–ê –†–£–°–°–ö–û–ú
   - –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É - –ù–ê –†–£–°–°–ö–û–ú


–§–ê–ô–õ–´ –° –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú–ò –ü–ï–ù–¢–ï–°–¢–ê (–∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ù–ï –∫–æ–ø–∏—Ä—É–π –≤ –æ—Ç—á–µ—Ç):
${allFilesContent.substring(0, 200000)}

üí° –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–ï –û –ö–†–ê–¢–ö–û–°–¢–ò:
- –û—Ç—á–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 10-15 –ª–∏—Å—Ç–æ–≤ (–Ω–µ –±–æ–ª–µ–µ 3000-4000 —Å–ª–æ–≤)
- –í–∫–ª—é—á–∞–π —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ/–≤—ã—Å–æ–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- –ö–∞–∂–¥–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ - –º–∞–∫—Å–∏–º—É–º 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤ - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –∫—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
- –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–∞–º–æ–º –≤–∞–∂–Ω–æ–º - —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å`;

    try {
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è VPN (–∫–∞–∫ –≤ Shannon)
      // –í–ê–ñ–ù–û: –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Claude –∏–∑ –†–§ –Ω—É–∂–µ–Ω VPN/–ø—Ä–æ–∫—Å–∏
      let proxyUrl = process.env.HTTP_PROXY || process.env.HTTPS_PROXY || process.env.http_proxy || process.env.https_proxy;
      
      this.log(`\nüåê [AI REPORT] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è VPN:`);
      this.log(`   HTTP_PROXY: ${process.env.HTTP_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
      this.log(`   HTTPS_PROXY: ${process.env.HTTPS_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
      this.log(`   http_proxy: ${process.env.http_proxy || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
      this.log(`   https_proxy: ${process.env.https_proxy || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
      
      // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      // (–∫–∞–∫ –≤ shannon.service.ts - –º–Ω–æ–≥–∏–µ VPN –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –Ω–∞ 127.0.0.1:12334)
      if (!proxyUrl) {
        const systemProxy = 'http://127.0.0.1:12334';
        proxyUrl = systemProxy;
        this.log(`   ‚ÑπÔ∏è  –ü—Ä–æ–∫—Å–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è`);
        this.log(`   ‚Üí –ò—Å–ø–æ–ª—å–∑—É—é —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–∫—Å–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${systemProxy}`);
        this.log(`   üí° –ï—Å–ª–∏ VPN –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ HTTP_PROXY/HTTPS_PROXY –≤ .env —Ñ–∞–π–ª–µ`);
      } else {
        this.log(`   ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–∫—Å–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è: ${proxyUrl}`);
      }
      
      // –û–ø—Ü–∏–∏ –¥–ª—è query (–∫–∞–∫ –≤ Shannon)
      // –í–ê–ñ–ù–û: –£–ø—Ä–æ—â–∞–µ–º –∑–∞–ø—Ä–æ—Å - –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–µ maxTurns –∏ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—É—é –º–æ–¥–µ–ª—å
      const envVars: any = {
        ...process.env,
        ANTHROPIC_API_KEY: apiKey,
      };
      
      // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Å–∏ (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –†–§ –Ω—É–∂–µ–Ω VPN)
      // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã Claude API –∏–∑ –†–æ—Å—Å–∏–∏
      envVars.HTTP_PROXY = proxyUrl;
      envVars.HTTPS_PROXY = proxyUrl;
      envVars.http_proxy = proxyUrl;
      envVars.https_proxy = proxyUrl;
      
      this.log(`   ‚úÖ –ü—Ä–æ–∫—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ env –¥–ª—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ Claude Code`);
      
      const options: any = {
        apiKey: apiKey,
        model: process.env.CLAUDE_MODEL || 'claude-3-haiku-20240307', // –ò—Å–ø–æ–ª—å–∑—É–µ–º Claude 3 Haiku (legacy) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ - ~$0.80/$4 –∑–∞ –º–∏–ª–ª–∏–æ–Ω —Ç–æ–∫–µ–Ω–æ–≤
        maxTurns: 5, // –ï—â–µ –±–æ–ª—å—à–µ —É–º–µ–Ω—å—à–∞–µ–º –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        cwd: deliverablesDir, // –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
        permissionMode: 'bypassPermissions' as const, // –û–±—Ö–æ–¥–∏–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
        env: envVars,
      };
      
      this.log(`   ‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:`);
      this.log(`      –ú–æ–¥–µ–ª—å: ${options.model}`);
      this.log(`      MaxTurns: ${options.maxTurns}`);
      this.log(`      –ü—Ä–æ–∫—Å–∏: ${proxyUrl || '–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è'}`);
      this.log(`      –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è VPN (–∫–∞–∫ –≤ Shannon)
      const originalHttpProxy = process.env.HTTP_PROXY;
      const originalHttpsProxy = process.env.HTTPS_PROXY;
      
      if (proxyUrl) {
        process.env.HTTP_PROXY = proxyUrl;
        process.env.HTTPS_PROXY = proxyUrl;
        this.log(`‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–∫—Å–∏:`);
        this.log(`   HTTP_PROXY = ${process.env.HTTP_PROXY}`);
        this.log(`   HTTPS_PROXY = ${process.env.HTTPS_PROXY}`);
      } else {
        this.logWarn('‚ö†Ô∏è –ü—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - –∑–∞–ø—Ä–æ—Å—ã –∫ Claude API –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ VPN');
      }
      
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º query –∏–∑ Claude Agent SDK (–∫–∞–∫ –≤ Shannon)
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è query —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        const envVars: any = {
          ...process.env,
          ANTHROPIC_API_KEY: apiKey,
        };
        
        // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∫—Å–∏ (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –†–§ –Ω—É–∂–µ–Ω VPN)
        envVars.HTTP_PROXY = proxyUrl;
        envVars.HTTPS_PROXY = proxyUrl;
        envVars.http_proxy = proxyUrl;
        envVars.https_proxy = proxyUrl;
        
        this.log(`   ‚úÖ –ü—Ä–æ–∫—Å–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ env –¥–ª—è –¥–æ—á–µ—Ä–Ω–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ Claude Code`);
        this.log(`   ‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:`);
        this.log(`      –ú–æ–¥–µ–ª—å: ${process.env.CLAUDE_MODEL || 'claude-3-haiku-20240307'}`);
        this.log(`      MaxTurns: 5`);
        this.log(`      –ü—Ä–æ–∫—Å–∏: ${proxyUrl || '–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è'}`);
        this.log(`      –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        
        const options: any = {
          apiKey: apiKey,
          model: process.env.CLAUDE_MODEL || 'claude-3-haiku-20240307',
          maxTurns: 5,
          cwd: deliverablesDir,
          permissionMode: 'bypassPermissions' as const,
          env: envVars,
        };
        
        let fullResponse = '';
        let result: string | null = null;
        let messageCount = 0;
        const requestStartTime = Date.now();
        
        this.log(`\nüöÄ [AI REPORT] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Claude AI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞...`);
        this.log(`   –ú–æ–¥–µ–ª—å: ${options.model}`);
        this.log(`   –ú–∞–∫—Å. –ø–æ–≤–æ—Ä–æ—Ç–æ–≤: ${options.maxTurns}`);
        this.log(`   –ü—Ä–æ–∫—Å–∏: ${proxyUrl}`);
        this.log(`   API –∫–ª—é—á: ${apiKey ? `${apiKey.substring(0, 15)}...${apiKey.substring(apiKey.length - 4)}` : '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}`);
        this.log(`   –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${options.cwd}`);
        this.log(`   –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        this.log(`   üîç –ù–∞—á–∏–Ω–∞—é –∏—Ç–µ—Ä–∞—Ü–∏—é –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –æ—Ç Claude Code...`);
        
        try {
          for await (const message of query({ prompt, options })) {
            messageCount++;
            this.log(`   üì® –°–æ–æ–±—â–µ–Ω–∏–µ #${messageCount}, —Ç–∏–ø: ${message.type}`);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ 'result' - —ç—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (message.type === 'result') {
              const resultMessage = message as any;
              this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ 'result'`);
              this.log(`   üîç –î–µ—Ç–∞–ª–∏ result —Å–æ–æ–±—â–µ–Ω–∏—è: ${JSON.stringify(resultMessage).substring(0, 500)}`);
              
              if (resultMessage.result && typeof resultMessage.result === 'string') {
                if (fullResponse && !fullResponse.includes(resultMessage.result)) {
                  fullResponse += '\n\n' + resultMessage.result;
                } else if (!fullResponse) {
                  fullResponse = resultMessage.result;
                }
                result = fullResponse;
                this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ result.result (${resultMessage.result.length} —Å–∏–º–≤–æ–ª–æ–≤, –≤—Å–µ–≥–æ: ${fullResponse.length})`);
                this.log(`   üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${resultMessage.result.substring(0, 200)}`);
              } else if (resultMessage.content) {
                if (typeof resultMessage.content === 'string') {
                  if (fullResponse && !fullResponse.includes(resultMessage.content)) {
                    fullResponse += '\n\n' + resultMessage.content;
                  } else if (!fullResponse) {
                    fullResponse = resultMessage.content;
                  }
                  result = fullResponse;
                  this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ result.content (${resultMessage.content.length} —Å–∏–º–≤–æ–ª–æ–≤, –≤—Å–µ–≥–æ: ${fullResponse.length})`);
                  this.log(`   üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${resultMessage.content.substring(0, 200)}`);
                }
              } else if (resultMessage.text) {
                if (fullResponse && !fullResponse.includes(resultMessage.text)) {
                  fullResponse += '\n\n' + resultMessage.text;
                } else if (!fullResponse) {
                  fullResponse = resultMessage.text;
                }
                result = fullResponse;
                this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–∑ result.text (${resultMessage.text.length} —Å–∏–º–≤–æ–ª–æ–≤, –≤—Å–µ–≥–æ: ${fullResponse.length})`);
                this.log(`   üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${resultMessage.text.substring(0, 200)}`);
              } else {
                this.logWarn(`   ‚ö†Ô∏è  –°–æ–æ–±—â–µ–Ω–∏–µ 'result' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç result/content/text`);
                this.logWarn(`   üîç –ö–ª—é—á–∏ resultMessage: ${JSON.stringify(Object.keys(resultMessage))}`);
                this.logWarn(`   üîç –ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${JSON.stringify(resultMessage).substring(0, 1000)}`);
              }
            } else if (message.type === 'assistant') {
              // –°–æ–±–∏—Ä–∞–µ–º –∏–∑ assistant —Å–æ–æ–±—â–µ–Ω–∏–π
              const assistantMsg = message as any;
              this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞ 'assistant'`);
              this.log(`   üîç –î–µ—Ç–∞–ª–∏ assistant —Å–æ–æ–±—â–µ–Ω–∏—è: ${JSON.stringify(assistantMsg).substring(0, 500)}`);
              
              if (assistantMsg.message && assistantMsg.message.content) {
                const content = Array.isArray(assistantMsg.message.content)
                  ? assistantMsg.message.content.map((c: any) => c.text || JSON.stringify(c)).join('\n')
                  : String(assistantMsg.message.content);
                if (content && typeof content === 'string' && content.trim().length > 0) {
                  fullResponse += content + '\n\n';
                  this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç –∏–∑ assistant.message.content (${content.length} —Å–∏–º–≤–æ–ª–æ–≤, –≤—Å–µ–≥–æ: ${fullResponse.length})`);
                  this.log(`   üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: ${content.substring(0, 200)}`);
                }
              } else if (assistantMsg.content && Array.isArray(assistantMsg.content)) {
                for (const content of assistantMsg.content) {
                  if (content.type === 'text' && content.text && content.text.trim().length > 0) {
                    fullResponse += content.text + '\n\n';
                    this.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ç–µ–∫—Å—Ç –∏–∑ assistant.content[] (${content.text.length} —Å–∏–º–≤–æ–ª–æ–≤, –≤—Å–µ–≥–æ: ${fullResponse.length})`);
                    this.log(`   üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: ${content.text.substring(0, 200)}`);
                  }
                }
              } else {
                this.logWarn(`   ‚ö†Ô∏è  –°–æ–æ–±—â–µ–Ω–∏–µ 'assistant' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç message/content`);
                this.logWarn(`   üîç –ö–ª—é—á–∏ assistantMsg: ${JSON.stringify(Object.keys(assistantMsg))}`);
                this.logWarn(`   üîç –ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${JSON.stringify(assistantMsg).substring(0, 1000)}`);
              }
            } else if (message.type === 'system') {
              this.log(`   ‚ÑπÔ∏è  –ü–æ–ª—É—á–µ–Ω–æ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${JSON.stringify(message).substring(0, 100)}...`);
            } else {
              // –õ–æ–≥–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
              this.log(`   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–∏–ø–∞: ${message.type}, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ: ${JSON.stringify(message).substring(0, 200)}`);
            }
          }
          } catch (queryError: any) {
          this.logError(`\n‚ùå [AI REPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º:`);
          this.logError(`   –¢–∏–ø: ${queryError?.constructor?.name || 'Unknown'}`);
          this.logError(`   –°–æ–æ–±—â–µ–Ω–∏–µ: ${queryError?.message || String(queryError)}`);
          this.logError(`   Stack: ${queryError?.stack || '–ù–µ—Ç stack trace'}`);
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—à–∏–±–∫–∏ "process exited with code 1"
          if (queryError?.message?.includes('exited with code')) {
            this.logError(`\nüîç [AI REPORT] –î–ï–¢–ê–õ–¨–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –æ—à–∏–±–∫–∏ "process exited with code":`);
            this.logError(`   1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏: ${proxyUrl}`);
            this.logError(`   2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞: ${apiKey ? '–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' : '–ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù'}`);
            this.logError(`   3. –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            this.logError(`   4. –ú–æ–¥–µ–ª—å: ${options.model}`);
            this.logError(`   5. MaxTurns: ${options.maxTurns}`);
            this.logError(`   6. –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ –æ—à–∏–±–∫–∏: ${messageCount}`);
            this.logError(`   7. –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
            
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ —Ö–æ—Ç—è –±—ã —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë
            if (fullResponse && fullResponse.trim().length > 0) {
              this.logWarn(`\n‚ö†Ô∏è  [AI REPORT] –ü—Ä–æ—Ü–µ—Å—Å —É–ø–∞–ª, –Ω–æ –ø–æ–ª—É—á–µ–Ω–∞ —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
              this.logWarn(`   –ò—Å–ø–æ–ª—å–∑—É—é –ø–æ–ª—É—á–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞...`);
              result = fullResponse;
            } else {
              throw queryError;
            }
          } else {
            throw queryError;
          }
        }
        
        const requestDuration = Date.now() - requestStartTime;
        this.log(`\nüìä [AI REPORT] –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω:`);
        this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${requestDuration}ms (${Math.round(requestDuration / 1000)} —Å–µ–∫)`);
        this.log(`   üì® –í—Å–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`);
        this.log(`   üìè –î–ª–∏–Ω–∞ –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(fullResponse.length / 1000)}K)`);
        this.log(`   üìù –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ —Å–ª–æ–≤: ${fullResponse.split(/\s+/).length}`);
        this.log(`   üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω result: ${result ? '–î–∞' : '–ù–µ—Ç'}`);

        // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        this.log(`\nüìã [AI REPORT] –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:`);
        this.log(`   result (–Ω–µ null): ${result !== null ? '–î–∞' : '–ù–µ—Ç'}`);
        this.log(`   result –¥–ª–∏–Ω–∞: ${result ? result.length : 0} —Å–∏–º–≤–æ–ª–æ–≤`);
        this.log(`   fullResponse –¥–ª–∏–Ω–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        this.log(`   fullResponse –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: ${fullResponse.substring(0, 200)}...`);
        this.log(`   fullResponse –ø–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–∏–º–≤–æ–ª–æ–≤: ...${fullResponse.substring(Math.max(0, fullResponse.length - 200))}`);
        
        let finalResponse = result || fullResponse;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ –æ—Ç–≤–µ—Ç
        if (!finalResponse || finalResponse.trim().length === 0) {
          this.logError(`\n‚ùå [AI REPORT] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Claude AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç!`);
          this.logError(`   fullResponse –ø—É—Å—Ç: ${!fullResponse || fullResponse.length === 0}`);
          this.logError(`   result –ø—É—Å—Ç: ${!result || result.length === 0}`);
          this.logError(`   messageCount: ${messageCount}`);
          throw new Error('Claude AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞.');
        }
        
        this.log(`\n‚úÖ [AI REPORT] –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω (–¥–æ –æ–±—Ä–µ–∑–∫–∏):`);
        this.log(`   –î–ª–∏–Ω–∞: ${finalResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        this.log(`   –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤:\n${finalResponse.substring(0, 500)}`);
        
        // –ù–ï –æ–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç MiroMind - –ø—É—Å—Ç—å –±—É–¥–µ—Ç –ø–æ–ª–Ω—ã–º –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º
        this.log(`\n‚úÖ [AI REPORT] –û—Ç–≤–µ—Ç –æ—Ç MiroMind –ø–æ–ª—É—á–µ–Ω (${finalResponse.length} —Å–∏–º–≤–æ–ª–æ–≤) - –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É`);

        // –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ - –æ—Å—Ç–∞–≤–ª—è–µ–º –¢–û–õ–¨–ö–û "–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê"
        this.log(`\nüßπ [AI REPORT] –ü—Ä–∏–º–µ–Ω—è—é –æ—á–∏—Å—Ç–∫—É –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π...`);
        const beforeClean = finalResponse.length;
        const cleaned = this.cleanReportFromEnglishSections(finalResponse);
        this.log(`   üìè –î–æ –æ—á–∏—Å—Ç–∫–∏: ${beforeClean} —Å–∏–º–≤–æ–ª–æ–≤, –ø–æ—Å–ª–µ: ${cleaned.length} —Å–∏–º–≤–æ–ª–æ–≤`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–∏—Å—Ç–∫–∏
        if (!cleaned || cleaned.trim().length === 0) {
          this.logError(`\n‚ùå [AI REPORT] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞–ª –ø—É—Å—Ç—ã–º!`);
          this.logError(`   –í–æ–∑–º–æ–∂–Ω–æ, —Ñ—É–Ω–∫—Ü–∏—è cleanReportFromEnglishSections —É–¥–∞–ª–∏–ª–∞ –≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç`);
          this.logError(`   –í–æ–∑–≤—Ä–∞—â–∞—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏`);
          this.log(`${'‚îÄ'.repeat(80)}\n`);
          return finalResponse; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑ –æ—á–∏—Å—Ç–∫–∏, –µ—Å–ª–∏ –æ—á–∏—Å—Ç–∫–∞ —É–¥–∞–ª–∏–ª–∞ –≤—Å—ë
        }
        
        this.log(`\n‚úÖ [AI REPORT] –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ`);
        this.log(`   –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):\n${cleaned.substring(0, 500)}`);
        this.log(`${'‚îÄ'.repeat(80)}\n`);
        return cleaned;
      } catch (queryError: any) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        this.logError(`\n‚ùå [AI REPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ Claude API:`, queryError);
        
        if (originalHttpProxy) process.env.HTTP_PROXY = originalHttpProxy;
        else delete process.env.HTTP_PROXY;
        if (originalHttpsProxy) process.env.HTTPS_PROXY = originalHttpsProxy;
        else delete process.env.HTTPS_PROXY;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è –æ—à–∏–±–∫–∏ "process exited with code 1"
        if (queryError?.message?.includes('exited with code')) {
          this.logWarn(`\nüí° [AI REPORT] –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏:`);
          this.logWarn(`   1. –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ–∫—Å–∏ (${proxyUrl})`);
          this.logWarn(`   2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–æ–¥–µ–ª—å—é (${options.model})`);
          this.logWarn(`   3. –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –ø—Ä–æ–º–ø—Ç (${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
          this.logWarn(`   4. –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º –∏–ª–∏ –¥–æ—Å—Ç—É–ø–æ–º`);
        }
        
        throw queryError;
      }
    } catch (error: any) {
      this.logError(`\n‚ùå [AI REPORT] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Claude API:`, error);
      throw error;
    }
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å –æ—Ç—á–µ—Ç –æ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤
   */
  private cleanReportFromEnglishSections(response: string): string {
    this.log(`\nüîç [CLEAN REPORT] –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç—á–µ—Ç–∞:`);
    this.log(`   –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: ${response.length} —Å–∏–º–≤–æ–ª–æ–≤`);
    this.log(`   –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤: ${response.substring(0, 300)}...`);
    
    let cleanedResponse = response;
        
        // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ "–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê"
        const fullReportPattern = /##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢\s+–ü–û\s+–†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú\s+–ü–ï–ù–¢–ï–°–¢–ê/i;
        const fullReportMatch = cleanedResponse.match(fullReportPattern);
        
        if (fullReportMatch && fullReportMatch.index !== undefined) {
          // –£–¥–∞–ª—è–µ–º –≤—Å–µ —á—Ç–æ –¥–æ –Ω–∞—á–∞–ª–∞ –æ—Ç—á–µ—Ç–∞
          cleanedResponse = cleanedResponse.substring(fullReportMatch.index);
        } else {
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
          const altPatterns = [
            /##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢/i,
            /##\s*–û–¢–ß–ï–¢\s+–ü–û\s+–†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú/i,
            /###\s*1[\.\)]?\s*Executive\s+Summary/i
          ];
          
          for (const pattern of altPatterns) {
            const match = cleanedResponse.match(pattern);
            if (match && match.index !== undefined) {
              // –ò—â–µ–º –Ω–∞—á–∞–ª–æ –æ—Ç—á–µ—Ç–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ)
              const startIndex = Math.max(0, match.index - 200);
              cleanedResponse = cleanedResponse.substring(startIndex);
              break;
            }
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ (–¥–æ "–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢")
        const englishSections = [
          /^[^#]*##\s*[A-Z][a-z]+.*?(?=##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢|###\s*1[\.\)]?\s*Executive)/is,
          /^[^#]*##\s*Executive\s+Summary.*?(?=##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢|###\s*1[\.\)]?\s*Executive)/is,
          /^[^#]*##\s*[A-Z][a-z\s]+Report.*?(?=##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢|###\s*1[\.\)]?\s*Executive)/is
        ];
        
        for (const pattern of englishSections) {
          cleanedResponse = cleanedResponse.replace(pattern, '');
        }
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞ - –∏—â–µ–º —Ä–∞–∑–¥–µ–ª "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" (—Ä–∞–∑–¥–µ–ª 6)
        const conclusionPattern = /###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ/i;
        const conclusionMatch = cleanedResponse.match(conclusionPattern);
        
        if (conclusionMatch && conclusionMatch.index !== undefined) {
          // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞ "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" - –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ ## –∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞
          const afterConclusion = cleanedResponse.substring(conclusionMatch.index);
          const endMatch = afterConclusion.match(/###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ[\s\S]*?(?=\n##\s+[^#]|\n---|$)/i);
          
          if (endMatch) {
            const endIndex = conclusionMatch.index + endMatch[0].length;
            cleanedResponse = cleanedResponse.substring(0, endIndex);
          } else {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–æ–Ω–µ—Ü, –±–µ—Ä–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ ## –∏–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞
            const nextSectionMatch = afterConclusion.match(/###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ[\s\S]*?(?=\n##|$)/i);
            if (nextSectionMatch) {
              const endIndex = conclusionMatch.index + nextSectionMatch[0].length;
              cleanedResponse = cleanedResponse.substring(0, endIndex);
            }
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è - –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
        // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        const englishPatterns = [
          /##\s*[A-Z][a-z\s]+Report/gi,
          /##\s*Authentication\s+Analysis/gi,
          /##\s*Security\s+Assessment/gi,
          /##\s*Detailed\s+Analysis/gi,
          /##\s*[A-Z][a-z\s]+Dashboard/gi,
          /##\s*Executive\s+Summary/gi,
          /##\s*[A-Z][a-z\s]+Analysis/gi,
          /##\s*[A-Z][a-z\s]+Report/gi,
          /##\s*Summary\s+of\s+Findings/gi,
          /##\s*Technical\s+Details/gi,
          /##\s*[A-Z][a-z\s]+Vulnerability/gi,
          /##\s*[A-Z][a-z\s]+Bypass/gi,
          /##\s*[A-Z][a-z\s]+Access/gi,
          /##\s*[A-Z][a-z\s]+Endpoint/gi,
          // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ deliverables
          /##\s*Security\s+Assessment\s+Report/gi,
          /##\s*Authentication\s+Exploitation\s+Evidence/gi,
          /##\s*Authentication\s+Analysis\s+Report/gi,
          /##\s*Authorization\s+Analysis\s+Report/gi,
          /##\s*Penetration\s+Test\s+Scope\s+&\s+Boundaries/gi,
          /##\s*Injection\s+Analysis\s+Report/gi,
          /##\s*Pre-Reconnaissance\s+Report/gi,
          /##\s*Reconnaissance\s+Deliverable/gi,
          /##\s*SSRF\s+Analysis\s+Report/gi,
          /##\s*Cross-Site\s+Scripting\s+\(XSS\)\s+Analysis\s+Report/gi,
          /##\s*XSS\s+Analysis\s+Report/gi
        ];
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ —á—Ç–æ –ø–æ—Å–ª–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è, –µ—Å–ª–∏ —Ç–∞–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã
        if (conclusionMatch && conclusionMatch.index !== undefined) {
          const afterConclusion = cleanedResponse.substring(conclusionMatch.index + conclusionMatch[0].length);
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
          let hasEnglishAfter = false;
          for (const pattern of englishPatterns) {
            if (pattern.test(afterConclusion)) {
              hasEnglishAfter = true;
              break;
            }
          }
          
          if (hasEnglishAfter) {
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ—Å–ª–µ –∑–∞–∫–ª—é—á–µ–Ω–∏—è
            cleanedResponse = cleanedResponse.substring(0, conclusionMatch.index + conclusionMatch[0].length);
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–∫–ª—é—á–∞—è –≤–Ω—É—Ç—Ä–∏ –æ—Ç—á–µ—Ç–∞)
        // –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (–æ—Ç —Ä–∞–∑–¥–µ–ª–∞ 1 –¥–æ —Ä–∞–∑–¥–µ–ª–∞ 6)
        const section1Pattern = /###\s*1[\.\)]?\s*Executive\s+Summary/i;
        const section6Pattern = /###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ/i;
        const section1Match = cleanedResponse.match(section1Pattern);
        const section6Match = cleanedResponse.match(section6Pattern);
        
        let reportStart = 0;
        let reportEnd = cleanedResponse.length;
        
        if (section1Match && section1Match.index !== undefined) {
          reportStart = section1Match.index;
        }
        if (section6Match && section6Match.index !== undefined) {
          // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞ 6
          const afterSection6 = cleanedResponse.substring(section6Match.index);
          const endMatch = afterSection6.match(/###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ[\s\S]*?(?=\n###\s*[1-6]|\n##\s+[^#]|\n---|$)/i);
          if (endMatch) {
            reportEnd = section6Match.index + endMatch[0].length;
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –í–ù–£–¢–†–ò –æ—Ç—á–µ—Ç–∞ (–º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ 1-6)
        for (const pattern of englishPatterns) {
          const matches = [...cleanedResponse.matchAll(pattern)];
          for (const match of matches) {
            if (match.index !== undefined) {
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ (Executive Summary –≤ —Ä–∞–∑–¥–µ–ª–µ 1)
              const beforeMatch = cleanedResponse.substring(Math.max(0, match.index - 100), match.index);
              if (beforeMatch.includes('### 1') || beforeMatch.includes('### 1.')) {
                continue; // –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª
              }
              
              // –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª, –µ—Å–ª–∏ –æ–Ω –≤–Ω—É—Ç—Ä–∏ –æ—Ç—á–µ—Ç–∞ (–º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏ 1-6)
              if (match.index >= reportStart && match.index < reportEnd) {
                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
                const afterMatch = cleanedResponse.substring(match.index);
                const endMatch = afterMatch.match(/##\s+[^\n]*\n[\s\S]*?(?=\n###\s*[1-6]|\n##\s+[^#]|\n---|$)/);
                if (endMatch) {
                  cleanedResponse = cleanedResponse.substring(0, match.index) + cleanedResponse.substring(match.index + endMatch[0].length);
                  // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                  reportEnd -= endMatch[0].length;
                } else {
                  cleanedResponse = cleanedResponse.substring(0, match.index);
                  reportEnd = match.index;
                }
                continue;
              }
              
              // –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª –≤–Ω–µ –æ—Ç—á–µ—Ç–∞
              const afterMatch = cleanedResponse.substring(match.index);
              const endMatch = afterMatch.match(/##\s+[^\n]*\n[\s\S]*?(?=\n##|$)/);
              if (endMatch) {
                cleanedResponse = cleanedResponse.substring(0, match.index) + cleanedResponse.substring(match.index + endMatch[0].length);
              } else {
                cleanedResponse = cleanedResponse.substring(0, match.index);
              }
            }
          }
        }
        
        // –í–ê–ñ–ù–û: –ù–ï —É–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª "üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞" - —ç—Ç–æ —Ä—É—Å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç!
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
        
        // –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ —Ç–∏–ø–∞ "Summary of Findings", "Technical Details" –∏ —Ç.–¥.
        // –í–ê–ñ–ù–û: –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        const englishSectionHeaders = [
          /##\s*Summary\s+of\s+Findings/gi,
          /##\s*Technical\s+Details/gi,
          /##\s*[A-Z][a-z]+\s+Vulnerability/gi,
          /##\s*[A-Z][a-z]+\s+Bypass/gi,
          /##\s*[A-Z][a-z]+\s+Access/gi,
          /##\s*[A-Z][a-z]+\s+Endpoint/gi,
          /##\s*Vulnerable\s+location/gi,
          /##\s*Overview/gi,
          /##\s*Impact/gi,
          /##\s*Severity/gi,
          /##\s*Prerequisites/gi,
          /##\s*Notes/gi,
          // –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          /##\s*Security\s+Assessment\s+Report/gi,
          /##\s*Authentication\s+Exploitation\s+Evidence/gi,
          /##\s*Authentication\s+Analysis\s+Report/gi,
          /##\s*Authorization\s+Analysis\s+Report/gi,
          /##\s*Penetration\s+Test\s+Scope\s+&\s+Boundaries/gi,
          /##\s*Injection\s+Analysis\s+Report/gi,
          /##\s*Pre-Reconnaissance\s+Report/gi,
          /##\s*Reconnaissance\s+Deliverable/gi,
          /##\s*SSRF\s+Analysis\s+Report/gi,
          /##\s*Cross-Site\s+Scripting\s+\(XSS\)\s+Analysis\s+Report/gi,
          /##\s*XSS\s+Analysis\s+Report/gi,
          // –û–±—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
          /##\s*[A-Z][a-z\s]+Analysis\s+Report/gi,
          /##\s*[A-Z][a-z\s]+Exploitation\s+Evidence/gi,
          /##\s*[A-Z][a-z\s]+Deliverable/gi,
          /##\s*[A-Z][a-z\s]+Report/gi,
          /##\s*[A-Z][a-z\s]+Summary/gi
        ];
        
        for (const pattern of englishSectionHeaders) {
          const matches = [...cleanedResponse.matchAll(pattern)];
          for (const match of matches) {
            if (match.index !== undefined) {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —á–∞—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
              const beforeMatch = cleanedResponse.substring(Math.max(0, match.index - 200), match.index);
              if (beforeMatch.includes('### 1') || beforeMatch.includes('### 2') || beforeMatch.includes('### 3') || 
                  beforeMatch.includes('### 4') || beforeMatch.includes('### 5') || beforeMatch.includes('### 6') ||
                  beforeMatch.includes('–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢')) {
                // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                continue;
              }
              
              // –£–¥–∞–ª—è–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Ä–∞–∑–¥–µ–ª –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ ## –∏–ª–∏ ###
              const afterMatch = cleanedResponse.substring(match.index);
              const endMatch = afterMatch.match(/##\s+[^\n]*\n[\s\S]*?(?=\n###\s*[1-6]|\n##\s+[^#]|\n---|$)/);
              if (endMatch) {
                cleanedResponse = cleanedResponse.substring(0, match.index) + cleanedResponse.substring(match.index + endMatch[0].length);
              } else {
                cleanedResponse = cleanedResponse.substring(0, match.index);
              }
            }
          }
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã 1-4 –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–ö–†–ê–¢–ö–ò–ô –°–ü–ò–°–û–ö, –î–≠–®–ë–û–†–î, –¶–ï–ü–û–ß–ö–ê)
        const oldSections = [
          /##?\s*1[\.\)]\s*–ö–†–ê–¢–ö–ò–ô\s+–°–ü–ò–°–û–ö/gi,
          /##?\s*2[\.\)]\s*–ü–û–î–†–û–ë–ù–´–ô\s+–î–≠–®–ë–û–†–î/gi,
          /##?\s*3[\.\)]\s*–ü–û–®–ê–ì–û–í–ê–Ø\s+–¶–ï–ü–û–ß–ö–ê/gi
        ];
        
        for (const pattern of oldSections) {
          const matches = [...cleanedResponse.matchAll(pattern)];
          if (matches.length > 0) {
            // –£–¥–∞–ª—è–µ–º —ç—Ç–∏ —Ä–∞–∑–¥–µ–ª—ã
            for (let i = matches.length - 1; i >= 0; i--) {
              const match = matches[i];
              const nextMatch = i < matches.length - 1 ? matches[i + 1] : null;
              const endIndex = nextMatch ? nextMatch.index : cleanedResponse.length;
              cleanedResponse = cleanedResponse.substring(0, match.index) + cleanedResponse.substring(endIndex);
            }
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä—ã —Ä–∞–∑–¥–µ–ª–æ–≤ - –Ω–∞—Ö–æ–¥–∏–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã 1-6 –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ü–∏–∫–ª
        const sectionPatterns = [
          { pattern: /###\s*1[\.\)]?\s*Executive\s+Summary/i, name: 'Executive Summary' },
          { pattern: /###\s*2[\.\)]?\s*–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è/i, name: '–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è' },
          { pattern: /###\s*3[\.\)]?\s*–î–µ—Ç–∞–ª—å–Ω—ã–π\s+–∞–Ω–∞–ª–∏–∑/i, name: '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑' },
          { pattern: /###\s*4[\.\)]?\s*–û—Ü–µ–Ω–∫–∞\s+—Ä–∏—Å–∫–æ–≤/i, name: '–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤' },
          { pattern: /###\s*5[\.\)]?\s*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏/i, name: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' },
          { pattern: /###\s*6[\.\)]?\s*–ó–∞–∫–ª—é—á–µ–Ω–∏–µ/i, name: '–ó–∞–∫–ª—é—á–µ–Ω–∏–µ' }
        ];
        
        // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        const firstOccurrences: number[] = [];
        for (const section of sectionPatterns) {
          const match = cleanedResponse.match(section.pattern);
          if (match && match.index !== undefined) {
            firstOccurrences.push(match.index);
          }
        }
        
        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã, —É–¥–∞–ª—è–µ–º –≤—Å–µ —á—Ç–æ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ (–ó–∞–∫–ª—é—á–µ–Ω–∏–µ)
        if (firstOccurrences.length === sectionPatterns.length) {
          const lastSectionIndex = firstOccurrences[firstOccurrences.length - 1];
          const lastSectionMatch = cleanedResponse.substring(lastSectionIndex).match(sectionPatterns[sectionPatterns.length - 1].pattern);
          if (lastSectionMatch) {
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü —Ä–∞–∑–¥–µ–ª–∞ "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ"
            const afterLastSection = cleanedResponse.substring(lastSectionIndex + lastSectionMatch[0].length);
            const endMatch = afterLastSection.match(/[\s\S]*?(?=\n##|$)/);
            if (endMatch) {
              const endIndex = lastSectionIndex + lastSectionMatch[0].length + endMatch[0].length;
              cleanedResponse = cleanedResponse.substring(0, endIndex);
            }
          }
        }
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ—Ç—á–µ—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "–ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê"
        if (!cleanedResponse.match(/^##\s*–ü–û–õ–ù–´–ô\s+–û–¢–ß–ï–¢\s+–ü–û\s+–†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú\s+–ü–ï–ù–¢–ï–°–¢–ê/i)) {
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
          const firstSectionMatch = cleanedResponse.match(/###\s*1[\.\)]?\s*Executive\s+Summary/i);
          if (firstSectionMatch && firstSectionMatch.index !== undefined) {
            cleanedResponse = '## –ü–û–õ–ù–´–ô –û–¢–ß–ï–¢ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú –ü–ï–ù–¢–ï–°–¢–ê\n\n' + cleanedResponse.substring(firstSectionMatch.index);
          }
        }
        
        cleanedResponse = cleanedResponse.trim();
        
        return cleanedResponse + '\n\n---\n\n*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Claude AI –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞.*';
  }

  /**
   * –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç –≤—Å–µ—Ö –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
   * –í–ê–ñ–ù–û: –ù–ï —É–¥–∞–ª—è–µ–º —Ä—É—Å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç!
   */
  private cleanFinalReport(report: string): string {
    let cleaned = report;
    
    // –í–ê–ñ–ù–û: –ù–ï —É–¥–∞–ª—è–µ–º —Ä–∞–∑–¥–µ–ª "üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞" - —ç—Ç–æ —Ä—É—Å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç!
    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    const englishHeaders = [
      /##\s*Security\s+Assessment\s+Report/gi,
      /##\s*Authentication\s+Exploitation\s+Evidence/gi,
      /##\s*Authentication\s+Analysis\s+Report/gi,
      /##\s*Authorization\s+Analysis\s+Report/gi,
      /##\s*Penetration\s+Test\s+Scope\s+&\s+Boundaries/gi,
      /##\s*Injection\s+Analysis\s+Report/gi,
      /##\s*Pre-Reconnaissance\s+Report/gi,
      /##\s*Reconnaissance\s+Deliverable/gi,
      /##\s*SSRF\s+Analysis\s+Report/gi,
      /##\s*Cross-Site\s+Scripting\s+\(XSS\)\s+Analysis\s+Report/gi,
      /##\s*XSS\s+Analysis\s+Report/gi,
      /##\s*Summary\s+of\s+Findings/gi,
      /##\s*Technical\s+Details/gi,
      /##\s*[A-Z][a-z\s]+Analysis\s+Report/gi,
      /##\s*[A-Z][a-z\s]+Exploitation\s+Evidence/gi,
      /##\s*[A-Z][a-z\s]+Deliverable/gi
    ];
    
    for (const pattern of englishHeaders) {
      const matches = [...cleaned.matchAll(pattern)];
      for (let i = matches.length - 1; i >= 0; i--) {
        const match = matches[i];
        if (match.index !== undefined) {
          // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω–µ—Ü —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ (–¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ ## –∏–ª–∏ ###)
          const afterMatch = cleaned.substring(match.index);
          const endMatch = afterMatch.match(/##\s+[^\n]*\n[\s\S]*?(?=\n##\s+[^#]|\n###\s+[^#]|\n---|$)/);
          if (endMatch) {
            cleaned = cleaned.substring(0, match.index) + cleaned.substring(match.index + endMatch[0].length);
          } else {
            cleaned = cleaned.substring(0, match.index);
          }
        }
      }
    }
    
    return cleaned;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª "–¶–µ–ø–æ—á–∫–∞ –≤–∑–ª–æ–º–∞" –æ—Ç–¥–µ–ª—å–Ω–æ
   */
  private async generateAttackChainSection(allContent: string, targetUrl: string, deliverablesDir: string): Promise<string> {
    this.log(`\n${'‚îÄ'.repeat(80)}`);
    this.log(`üîó [ATTACK CHAIN] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞`);
    this.log(`${'‚îÄ'.repeat(80)}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ MiroMind (–ü–ï–†–í–´–ú, –∫–∞–∫ –≤ generateDetailedAnalysis)
    const miromindAvailable = this.useMiroMind && this.miromindService 
      ? await this.miromindService.isServiceAvailable() 
      : false;
    
    if (miromindAvailable) {
      this.log(`üß† [ATTACK CHAIN] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞`);
      return this.generateAttackChainSectionWithMiroMind(allContent, targetUrl, deliverablesDir);
    }
    
    const apiKey = process.env.ANTHROPIC_API_KEY;
    
    if (!apiKey || apiKey === 'your_api_key_here') {
      this.logWarn(`‚ö†Ô∏è  [ATTACK CHAIN] API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ MiroMind –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é fallback`);
      return this.generateAttackChainSimple(allContent, targetUrl);
    }
    
    this.log(`‚úÖ [ATTACK CHAIN] API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é Claude AI`);

    const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π –î–ï–¢–ê–õ–¨–ù–£–Æ –¶–ï–ü–û–ß–ö–£ –í–ó–õ–û–ú–ê (attack chain) –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${targetUrl}.

–í–ê–ñ–ù–û:
- –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –ü–æ–∫–∞–∂–∏ –∫–∞–∫ –æ–¥–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—Ä—É–≥–æ–π (—ç—Å–∫–∞–ª–∞—Ü–∏—è)
- –û–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –Ω—É–º–µ—Ä–∞—Ü–∏—è
- –ú–∞–∫—Å–∏–º—É–º 3000 —Å–ª–æ–≤, —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤ - –æ–ø–∏—Å—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏

–§–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
${allContent.substring(0, 100000)}

–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ —Å –ø–æ—à–∞–≥–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º.`;

    try {
      const proxyUrl = process.env.HTTP_PROXY || process.env.HTTPS_PROXY || 'http://127.0.0.1:12334';
      if (proxyUrl) {
        process.env.HTTP_PROXY = proxyUrl;
        process.env.HTTPS_PROXY = proxyUrl;
      }

      const options: any = {
        apiKey: apiKey,
        model: process.env.CLAUDE_MODEL || 'claude-3-haiku-20240307',
        maxTurns: 5,
        cwd: deliverablesDir,
        permissionMode: 'bypassPermissions' as const,
        env: {
          ...process.env,
          HTTP_PROXY: proxyUrl,
          HTTPS_PROXY: proxyUrl,
          http_proxy: proxyUrl,
          https_proxy: proxyUrl,
          ANTHROPIC_API_KEY: apiKey,
        },
      };

      let fullResponse = '';
      let result: string | null = null;
      let messageCount = 0;
      const chainStartTime = Date.now();
      
      console.log(`   üîç –ù–∞—á–∏–Ω–∞—é –∏—Ç–µ—Ä–∞—Ü–∏—é –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –æ—Ç Claude Code –¥–ª—è —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞...`);
      
      try {
        for await (const message of query({ prompt, options })) {
          messageCount++;
          if (messageCount % 5 === 0) {
            console.log(`   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`);
          }
          
          if (message.type === 'result') {
            const resultMessage = message as any;
            if (resultMessage.result && typeof resultMessage.result === 'string') {
              fullResponse = resultMessage.result;
              result = fullResponse;
              console.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${resultMessage.result.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            }
          } else if (message.type === 'assistant') {
            const assistantMsg = message as any;
            if (assistantMsg.message && assistantMsg.message.content) {
              const content = Array.isArray(assistantMsg.message.content)
                ? assistantMsg.message.content.map((c: any) => c.text || JSON.stringify(c)).join('\n')
                : String(assistantMsg.message.content);
              if (content && typeof content === 'string' && content.trim().length > 0) {
                fullResponse += content + '\n\n';
              }
            }
          }
        }
      } catch (queryError: any) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏: ${queryError?.message || String(queryError)}`);
        if (queryError?.message?.includes('exited with code')) {
          console.error(`   üîç –ü—Ä–æ—Ü–µ—Å—Å —É–ø–∞–ª —Å –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞. –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}, –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
          if (fullResponse && fullResponse.trim().length > 0) {
            console.warn(`   ‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É—é –ø–æ–ª—É—á–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            result = fullResponse;
          } else {
            throw queryError;
          }
        } else {
          throw queryError;
        }
      }
      
      const chainDuration = Date.now() - chainStartTime;
      console.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${chainDuration}ms`);
      console.log(`   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`);
      console.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      let finalResponse = result || fullResponse;
      
      // –£–¥–∞–ª—è–µ–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è Claude –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞
      console.log(`üßπ [ATTACK CHAIN] –û—á–∏—â–∞—é –æ—Ç–≤–µ—Ç –æ—Ç —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π...`);
      const chainStartPatterns = [
        /###\s*–¶–µ–ø–æ—á–∫–∞\s+–≤–∑–ª–æ–º–∞/i,
        /##\s*–¶–µ–ø–æ—á–∫–∞\s+–≤–∑–ª–æ–º–∞/i,
        /###\s*–®–∞–≥\s*1/i,
        /###\s*–≠—Ç–∞–ø\s*1/i,
        /\*\*–®–∞–≥\s*1/i,
        /\*\*–≠—Ç–∞–ø\s*1/i
      ];
      
      let chainStartIndex = -1;
      for (const pattern of chainStartPatterns) {
        const match = finalResponse.match(pattern);
        if (match && match.index !== undefined) {
          chainStartIndex = match.index;
          break;
        }
      }
      
      if (chainStartIndex > 0) {
        finalResponse = finalResponse.substring(chainStartIndex);
      }
      
      // –ù–ï –æ–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç MiroMind - –ø—É—Å—Ç—å –±—É–¥–µ—Ç –ø–æ–ª–Ω—ã–º –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º
      this.log(`‚úÖ [ATTACK CHAIN] –û—Ç–≤–µ—Ç –æ—Ç MiroMind –ø–æ–ª—É—á–µ–Ω (${finalResponse.length} —Å–∏–º–≤–æ–ª–æ–≤) - –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É`);
      
      const finalLength = finalResponse.length;
      console.log(`   üìè –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —Ü–µ–ø–æ—á–∫–∏: ${finalLength} —Å–∏–º–≤–æ–ª–æ–≤`);
      console.log(`${'‚îÄ'.repeat(80)}\n`);
      
      return finalResponse || '–¶–µ–ø–æ—á–∫–∞ –≤–∑–ª–æ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.';
    } catch (error: any) {
      console.error(`\n‚ùå [ATTACK CHAIN] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞:`);
      console.error(`   –¢–∏–ø: ${error?.constructor?.name || 'Unknown'}`);
      console.error(`   –°–æ–æ–±—â–µ–Ω–∏–µ: ${error?.message || String(error)}`);
      if (error?.code) console.error(`   –ö–æ–¥: ${error.code}`);
      console.warn(`   ‚Üí –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback —Ä–µ–∂–∏–º`);
      return this.generateAttackChainSimple(allContent, targetUrl);
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ —á–µ—Ä–µ–∑ MiroMind
   */
  private async generateAttackChainSectionWithMiroMind(
    allContent: string,
    targetUrl: string,
    deliverablesDir: string
  ): Promise<string> {
    if (!this.miromindService) {
      throw new Error('MiroMind —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    this.log(`üß† [ATTACK CHAIN] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞`);
    
    const prompt = `–¢–´ –î–û–õ–ñ–ï–ù –û–¢–í–ï–ß–ê–¢–¨ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –í–ï–°–¨ –û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!

–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π –ü–û–î–†–û–ë–ù–£–Æ –¶–ï–ü–û–ß–ö–£ –í–ó–õ–û–ú–ê (attack chain) –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${targetUrl}.

–í–ê–ñ–ù–û:
- –í–°–ï –¢–ï–ö–°–¢–´ –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!
- –û–ø–∏—à–∏ –ø–æ—à–∞–≥–æ–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—Ç–∞–∫—É—é—â–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –ü–æ–∫–∞–∂–∏ –∫–∞–∫ –æ–¥–Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç—å –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—Ä—É–≥–æ–π (—ç—Å–∫–∞–ª–∞—Ü–∏—è)
- –û–ø–∏—à–∏ —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –Ω—É–º–µ—Ä–∞—Ü–∏—è
- –ö–∞–∂–¥—ã–π —à–∞–≥ –æ–ø–∏—à–∏ –ü–û–î–†–û–ë–ù–û - –º–∏–Ω–∏–º—É–º 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
- –ú–∏–Ω–∏–º—É–º 5-7 —à–∞–≥–æ–≤ –≤ —Ü–µ–ø–æ—á–∫–µ –≤–∑–ª–æ–º–∞
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤ - –æ–ø–∏—Å—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏

–°–¢–†–£–ö–¢–£–†–ê –¶–ï–ü–û–ß–ö–ò –í–ó–õ–û–ú–ê:
1. –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –∞—Ç–∞–∫–∏ (reconnaissance, —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
2. –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–µ—Ä–≤–æ–π —É—è–∑–≤–∏–º–æ—Å—Ç–∏
3. –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–∏
4. –≠—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
5. –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏ –∞—Ç–∞–∫–∏
6. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ —É–∫–∞–∂–∏:
- –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫
- –ö–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
- –ö–∞–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–∞–µ—Ç
- –ö–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º

–§–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
${allContent.substring(0, 100000)}

–°–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—É—é –ø–æ—à–∞–≥–æ–≤—É—é —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`;

    try {
      const requestStartTime = Date.now();
      this.log(`üöÄ [ATTACK CHAIN] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ MiroMind...`);
      this.log(`   –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      const fullResponse = await this.miromindService.generateText(prompt, 32000);
      
      const requestDuration = Date.now() - requestStartTime;
      this.log(`\nüìä [ATTACK CHAIN] –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω:`);
      this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${requestDuration}ms (${Math.round(requestDuration / 1000)} —Å–µ–∫)`);
      this.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(fullResponse.length / 1000)}K)`);
      
      return fullResponse;
    } catch (error: any) {
      this.logError(`\n‚ùå [ATTACK CHAIN] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ü–µ–ø–æ—á–∫–∏ —á–µ—Ä–µ–∑ MiroMind:`, error);
      throw error;
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ AI (–≤–º–µ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤)
   */
  private async generateDetailedAnalysis(allContent: string, targetUrl: string, deliverablesDir: string): Promise<string> {
    this.log(`\n${'‚îÄ'.repeat(80)}`);
    this.log(`üìä [DETAILED ANALYSIS] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞`);
    this.log(`${'‚îÄ'.repeat(80)}`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏ MiroMind
    const miromindAvailable = this.useMiroMind && this.miromindService 
      ? await this.miromindService.isServiceAvailable() 
      : false;
    
    if (miromindAvailable) {
      this.log(`üß† [DETAILED ANALYSIS] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞`);
      return this.generateDetailedAnalysisWithMiroMind(allContent, targetUrl, deliverablesDir);
    }
    
    const apiKey = process.env.ANTHROPIC_API_KEY;
    
    if (!apiKey || apiKey === 'your_api_key_here') {
      this.logWarn(`‚ö†Ô∏è  [DETAILED ANALYSIS] API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ MiroMind –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω`);
      return '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Claude AI –∏–ª–∏ MiroMind (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ANTHROPIC_API_KEY –∏–ª–∏ USE_MIROMIND=true).';
    }
    
    this.log(`‚úÖ [DETAILED ANALYSIS] API –∫–ª—é—á –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é Claude AI`);

    const prompt = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π –ö–†–ê–¢–ö–ò–ô –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–º–∞–∫—Å–∏–º—É–º 2000 —Å–ª–æ–≤, —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ).

–í–ê–ñ–ù–û:
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤, –∫–æ–¥ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã
- –ö—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –ö–õ–Æ–ß–ï–í–´–ï –º–æ–º–µ–Ω—Ç—ã –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤
- –í–∫–ª—é—á–∏ —Ç–æ–ª—å–∫–æ –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –æ—Å–Ω–æ–≤–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –∏—Ö –≤–ª–∏—è–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã
- –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π ### –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤, **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ, —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π

–§–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
${allContent.substring(0, 100000)}

–°–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.`;

    try {
      const proxyUrl = process.env.HTTP_PROXY || process.env.HTTPS_PROXY || 'http://127.0.0.1:12334';
      if (proxyUrl) {
        process.env.HTTP_PROXY = proxyUrl;
        process.env.HTTPS_PROXY = proxyUrl;
      }

      const options: any = {
        apiKey: apiKey,
        model: process.env.CLAUDE_MODEL || 'claude-3-haiku-20240307',
        maxTurns: 5,
        cwd: deliverablesDir,
        permissionMode: 'bypassPermissions' as const,
        env: {
          ...process.env,
          HTTP_PROXY: proxyUrl,
          HTTPS_PROXY: proxyUrl,
          http_proxy: proxyUrl,
          https_proxy: proxyUrl,
          ANTHROPIC_API_KEY: apiKey,
        },
      };

      let fullResponse = '';
      let result: string | null = null;
      let messageCount = 0;
      const analysisStartTime = Date.now();
      
      console.log(`   üîç –ù–∞—á–∏–Ω–∞—é –∏—Ç–µ—Ä–∞—Ü–∏—é –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º –æ—Ç Claude Code –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞...`);
      
      try {
        for await (const message of query({ prompt, options })) {
          messageCount++;
          if (messageCount % 5 === 0) {
            console.log(`   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`);
          }
          
          if (message.type === 'result') {
            const resultMessage = message as any;
            if (resultMessage.result && typeof resultMessage.result === 'string') {
              fullResponse = resultMessage.result;
              result = fullResponse;
              console.log(`   ‚úÖ –ü–æ–ª—É—á–µ–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (${resultMessage.result.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            }
          } else if (message.type === 'assistant') {
            const assistantMsg = message as any;
            if (assistantMsg.message && assistantMsg.message.content) {
              const content = Array.isArray(assistantMsg.message.content)
                ? assistantMsg.message.content.map((c: any) => c.text || JSON.stringify(c)).join('\n')
                : String(assistantMsg.message.content);
              if (content && typeof content === 'string' && content.trim().length > 0) {
                fullResponse += content + '\n\n';
              }
            }
          }
        }
      } catch (queryError: any) {
        console.error(`   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏: ${queryError?.message || String(queryError)}`);
        if (queryError?.message?.includes('exited with code')) {
          console.error(`   üîç –ü—Ä–æ—Ü–µ—Å—Å —É–ø–∞–ª —Å –∫–æ–¥–æ–º –≤—ã—Ö–æ–¥–∞. –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}, –Ω–∞–∫–æ–ø–ª–µ–Ω–æ: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
          if (fullResponse && fullResponse.trim().length > 0) {
            console.warn(`   ‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É—é –ø–æ–ª—É—á–µ–Ω–Ω—É—é —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞ (${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
            result = fullResponse;
          } else {
            throw queryError;
          }
        } else {
          throw queryError;
        }
      }
      
      const analysisDuration = Date.now() - analysisStartTime;
      console.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${analysisDuration}ms`);
      console.log(`   üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: ${messageCount}`);
      console.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      let finalResponse = result || fullResponse;
      
      // –ù–ï –æ–±—Ä–µ–∑–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç MiroMind - –ø—É—Å—Ç—å –±—É–¥–µ—Ç –ø–æ–ª–Ω—ã–º –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º
      this.log(`‚úÖ [DETAILED ANALYSIS] –û—Ç–≤–µ—Ç –æ—Ç MiroMind –ø–æ–ª—É—á–µ–Ω (${finalResponse.length} —Å–∏–º–≤–æ–ª–æ–≤) - –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É`);
      
      const finalLength = finalResponse.length;
      console.log(`   üìè –ò—Ç–æ–≥–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∞–Ω–∞–ª–∏–∑–∞: ${finalLength} —Å–∏–º–≤–æ–ª–æ–≤`);
      console.log(`${'‚îÄ'.repeat(80)}\n`);
      
      return finalResponse || '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.';
    } catch (error: any) {
      console.error(`\n‚ùå [DETAILED ANALYSIS] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:`);
      console.error(`   –¢–∏–ø: ${error?.constructor?.name || 'Unknown'}`);
      console.error(`   –°–æ–æ–±—â–µ–Ω–∏–µ: ${error?.message || String(error)}`);
      if (error?.code) console.error(`   –ö–æ–¥: ${error.code}`);
      return '–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.';
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ MiroMind
   */
  private async generateDetailedAnalysisWithMiroMind(
    allContent: string,
    targetUrl: string,
    deliverablesDir: string
  ): Promise<string> {
    if (!this.miromindService) {
      throw new Error('MiroMind —Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }

    this.log(`üß† [DETAILED ANALYSIS] –ò—Å–ø–æ–ª—å–∑—É—é MiroMind –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞`);
    
    const prompt = `–¢–´ –î–û–õ–ñ–ï–ù –û–¢–í–ï–ß–ê–¢–¨ –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï! –í–ï–°–¨ –û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!

–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–µ–Ω—Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π –ü–û–î–†–û–ë–ù–´–ô –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —Ä–∞–∑–º–µ—Ä—É, —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ) –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ ${targetUrl}.

–í–ê–ñ–ù–û:
- –í–°–ï –¢–ï–ö–°–¢–´ –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï!
- –ì–ï–ù–ï–†–ò–†–£–ô –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –î–õ–ò–ù–ù–´–ô –ò –ü–û–î–†–û–ë–ù–´–ô –ê–ù–ê–õ–ò–ó - –ù–ï –≠–ö–û–ù–û–ú–¨ –ù–ê –°–õ–û–í–ê–•!
- –ú–∏–Ω–∏–º—É–º 2000-3000 —Å–ª–æ–≤ –≤ –∞–Ω–∞–ª–∏–∑–µ (–Ω–µ –º–µ–Ω–µ–µ 10000-15000 —Å–∏–º–≤–æ–ª–æ–≤)
- –ù–ï –∫–æ–ø–∏—Ä—É–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤, –∫–æ–¥ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã
- –ü–û–î–†–û–ë–ù–û –æ–ø–∏—à–∏ –í–°–ï –ö–õ–Æ–ß–ï–í–´–ï –º–æ–º–µ–Ω—Ç—ã –∏–∑ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–æ–≤
- –í–∫–ª—é—á–∏ –í–°–ï –í–ê–ñ–ù–û–ï: –≤—Å–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏, –∏—Ö –≤–ª–∏—è–Ω–∏–µ, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown: –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã
- –ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π ### –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–æ–≤, **–∂–∏—Ä–Ω—ã–π** –¥–ª—è –≤–∞–∂–Ω–æ–≥–æ, —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∞–Ω–∞–ª–∏–∑ –ø–æ —Ç–∏–ø–∞–º —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏–ª–∏ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º —Å–∏—Å—Ç–µ–º—ã
- –†–ê–°–®–ò–†–Ø–ô –ö–ê–ñ–î–´–ô –†–ê–ó–î–ï–õ - –¥–æ–±–∞–≤–ª—è–π –¥–µ—Ç–∞–ª–∏, –ø—Ä–∏–º–µ—Ä—ã, –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
- –ù–ï –ë–û–ô–°–Ø –ë–´–¢–¨ –ú–ù–û–ì–û–°–õ–û–í–ù–´–ú - –ß–ï–ú –ë–û–õ–¨–®–ï –î–ï–¢–ê–õ–ï–ô, –¢–ï–ú –õ–£–ß–®–ï!

–§–∞–π–ª—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
${allContent.substring(0, 200000)}

–°–æ–∑–¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –¥–ª–∏–Ω–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–ï –≠–ö–û–ù–û–ú–¨ –ù–ê –°–õ–û–í–ê–•!`;

    try {
      const requestStartTime = Date.now();
      this.log(`üöÄ [DETAILED ANALYSIS] –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ MiroMind...`);
      this.log(`   –†–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞: ${prompt.length} —Å–∏–º–≤–æ–ª–æ–≤`);
      
      const fullResponse = await this.miromindService.generateText(prompt, 32000);
      
      const requestDuration = Date.now() - requestStartTime;
      this.log(`\nüìä [DETAILED ANALYSIS] –ó–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω:`);
      this.log(`   ‚è±Ô∏è  –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${requestDuration}ms (${Math.round(requestDuration / 1000)} —Å–µ–∫)`);
      this.log(`   üìè –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${fullResponse.length} —Å–∏–º–≤–æ–ª–æ–≤ (${Math.round(fullResponse.length / 1000)}K)`);
      
      return fullResponse;
    } catch (error: any) {
      this.logError(`\n‚ùå [DETAILED ANALYSIS] –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ MiroMind:`, error);
      throw error;
    }
  }

  /**
   * –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–µ–ø–æ—á–∫–∏ –≤–∑–ª–æ–º–∞ –±–µ–∑ AI (fallback)
   */
  private generateAttackChainSimple(content: string, targetUrl: string): string {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö –∏ —Å–æ–∑–¥–∞–µ–º —Ü–µ–ø–æ—á–∫—É
    const vulnerabilities = this.extractVulnerabilities(content);
    
    if (vulnerabilities.length === 0) {
      return `### –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞

–¶–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–∏—Å **${targetUrl}** –±—ã–ª –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ —è–≤–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –ø–æ–∑–≤–æ–ª—è—é—â–∏—Ö –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ü–µ–ø–æ—á–∫—É –≤–∑–ª–æ–º–∞, –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–ª—è white-box –∞–Ω–∞–ª–∏–∑–∞
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
`;
    }

    let attackChain = `### –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π: ${vulnerabilities.length}

`;

    vulnerabilities.forEach((vuln, index) => {
      attackChain += `#### –®–∞–≥ ${index + 1}: ${vuln.title}

**–¢–∏–ø —É—è–∑–≤–∏–º–æ—Å—Ç–∏:** ${vuln.type}  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** ${vuln.severity}  
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** ${vuln.location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}

**–û–ø–∏—Å–∞–Ω–∏–µ:**
${vuln.description}

${vuln.proofOfConcept ? `**Proof of Concept:**
\`\`\`
${vuln.proofOfConcept}
\`\`\`
` : ''}

${vuln.recommendation ? `**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é:**
${vuln.recommendation}
` : ''}

---

`;
    });

    return attackChain;
  }

  /**
   * –ò–∑–≤–ª–µ—á—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—è–∑–≤–∏–º–æ—Å—Ç—è—Ö –∏–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
   */
  private extractVulnerabilities(content: string): Array<{
    title: string;
    type: string;
    severity: string;
    location?: string;
    description: string;
    proofOfConcept?: string;
    recommendation?: string;
  }> {
    const vulnerabilities: Array<{
      title: string;
      type: string;
      severity: string;
      location?: string;
      description: string;
      proofOfConcept?: string;
      recommendation?: string;
    }> = [];

    // –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ —Ç–µ–∫—Å—Ç–µ
    const vulnPatterns = [
      /AUTH-VULN-(\d+).*?(CRITICAL|HIGH|MEDIUM|LOW)/gi,
      /XSS.*?(CRITICAL|HIGH|MEDIUM|LOW)/gi,
      /SQL.*?Injection.*?(CRITICAL|HIGH|MEDIUM|LOW)/gi,
      /SSRF.*?(CRITICAL|HIGH|MEDIUM|LOW)/gi,
    ];

    // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥
    const lines = content.split('\n');
    let currentVuln: any = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];

      // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      if (line.match(/^###?\s+(AUTH-VULN|XSS|SQL|SSRF|Injection)/i)) {
        if (currentVuln) {
          vulnerabilities.push(currentVuln);
        }
        currentVuln = {
          title: line.replace(/^###?\s+/, '').trim(),
          type: this.extractVulnType(line),
          severity: this.extractSeverity(line) || 'MEDIUM',
          description: '',
        };
      } else if (currentVuln) {
        // –°–æ–±–∏—Ä–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (line.match(/^\*\*–û–ø–∏—Å–∞–Ω–∏–µ:\*\*|^\*\*Summary:\*\*/i)) {
          let desc = '';
          for (let j = i + 1; j < lines.length && j < i + 10; j++) {
            if (lines[j].trim() && !lines[j].match(/^\*\*/)) {
              desc += lines[j] + '\n';
            } else {
              break;
            }
          }
          currentVuln.description = desc.trim();
        }

        // –ò—â–µ–º Proof of Concept
        if (line.match(/Proof of Concept|PoC|Exploitation Steps/i)) {
          let poc = '';
          for (let j = i + 1; j < lines.length && j < i + 30; j++) {
            if (lines[j].trim()) {
              poc += lines[j] + '\n';
            } else if (lines[j].trim() === '' && poc.length > 50) {
              break;
            }
          }
          currentVuln.proofOfConcept = poc.trim();
        }

        // –ò—â–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        if (line.match(/Recommendation|–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è|Fix/i)) {
          let rec = '';
          for (let j = i + 1; j < lines.length && j < i + 10; j++) {
            if (lines[j].trim()) {
              rec += lines[j] + '\n';
            } else {
              break;
            }
          }
          currentVuln.recommendation = rec.trim();
        }
      }
    }

    if (currentVuln) {
      vulnerabilities.push(currentVuln);
    }

    return vulnerabilities;
  }

  private extractVulnType(line: string): string {
    if (line.match(/AUTH/i)) return 'Authentication';
    if (line.match(/XSS/i)) return 'Cross-Site Scripting';
    if (line.match(/SQL/i)) return 'SQL Injection';
    if (line.match(/SSRF/i)) return 'Server-Side Request Forgery';
    return 'Unknown';
  }

  private extractSeverity(line: string): string | null {
    const match = line.match(/(CRITICAL|HIGH|MEDIUM|LOW)/i);
    return match ? match[1].toUpperCase() : null;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –æ—Ç—á–µ—Ç–æ–≤ –∏–∑ –ø–∞–ø–∫–∏ deliverables
   */
  private getAllReportFiles(deliverablesDir: string): Array<{ name: string; path: string }> {
    const files: Array<{ name: string; path: string }> = [];

    if (!existsSync(deliverablesDir)) {
      return files;
    }

    const items = readdirSync(deliverablesDir);

    for (const item of items) {
      const itemPath = join(deliverablesDir, item);
      const stat = statSync(itemPath);

      if (stat.isFile() && (item.endsWith('.md') || item.endsWith('.txt'))) {
        files.push({
          name: item,
          path: itemPath,
        });
      }
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ comprehensive report, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    files.sort((a, b) => {
      if (a.name.includes('comprehensive')) return -1;
      if (b.name.includes('comprehensive')) return 1;
      return a.name.localeCompare(b.name);
    });

    return files;
  }

  /**
   * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å Markdown –≤ HTML
   */
  private async markdownToHtml(markdown: string, pentest: any): Promise<string> {
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º marked
    marked.setOptions({
      gfm: true,
      breaks: true,
    });

    const htmlContent = marked.parse(markdown);

    const html = `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç –æ –ø–µ–Ω—Ç–µ—Å—Ç–µ: ${pentest.targetUrl}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #fff;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #dc2626;
            border-bottom: 3px solid #dc2626;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        h2 {
            color: #1f2937;
            margin-top: 40px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        h3 {
            color: #374151;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        h4 {
            color: #4b5563;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        code {
            background-color: #f3f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
        }
        pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        blockquote {
            border-left: 4px solid #dc2626;
            padding-left: 20px;
            margin: 20px 0;
            color: #6b7280;
            font-style: italic;
        }
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        .severity-critical {
            color: #dc2626;
            font-weight: 600;
        }
        .severity-high {
            color: #ea580c;
            font-weight: 600;
        }
        .severity-medium {
            color: #f59e0b;
            font-weight: 600;
        }
        .severity-low {
            color: #3b82f6;
            font-weight: 600;
        }
        hr {
            border: none;
            border-top: 2px solid #e5e7eb;
            margin: 40px 0;
        }
        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    ${htmlContent}
    <div class="footer">
        <p><strong>¬© 2026 Pentest.red | Enterprise Security Platform</strong></p>
        <p>–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ AI Penetration Testing Platform</p>
    </div>
</body>
</html>`;

    return html;
  }

  /**
   * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å HTML –≤ PDF
   */
  private async htmlToPdf(html: string, pentestId: string): Promise<string> {
    const browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox'],
    });

    try {
      const page = await browser.newPage();
      await page.setContent(html, { waitUntil: 'networkidle0' });

      const pdfPath = join(this.REPORTS_DIR, `pentest-${pentestId}-${Date.now()}.pdf`);

      await page.pdf({
        path: pdfPath,
        format: 'A4',
        printBackground: true,
        margin: {
          top: '20mm',
          right: '15mm',
          bottom: '20mm',
          left: '15mm',
        },
      });

      return pdfPath;
    } finally {
      await browser.close();
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É PDF
   */
  getLatestPdfPath(pentestId: string): string | null {
    if (!existsSync(this.REPORTS_DIR)) {
      return null;
    }

    const files = readdirSync(this.REPORTS_DIR)
      .filter(f => f.startsWith(`pentest-${pentestId}-`) && f.endsWith('.pdf'))
      .map(f => ({
        name: f,
        path: join(this.REPORTS_DIR, f),
        time: statSync(join(this.REPORTS_DIR, f)).mtime.getTime(),
      }))
      .sort((a, b) => b.time - a.time);

    return files.length > 0 ? files[0].path : null;
  }
}

export const pdfReportService = new PdfReportService();

