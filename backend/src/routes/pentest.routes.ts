import { Router, Request, Response } from 'express';
import { pentestService } from '../services/pentest.service';
import { PentestConfig } from '../types/pentest';
import { vulnerabilityTrackingService } from '../services/vulnerability-tracking.service';

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º shannonService —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ shannonService...');
let shannonService: any = null;
try {
  shannonService = require('../services/shannon.service').shannonService;
  console.log('‚úÖ shannonService –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
} catch (error: any) {
  console.warn('‚ö†Ô∏è shannonService –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω:', error?.message || error);
  console.warn('   Stack:', error.stack);
  console.warn('   –ü–µ–Ω—Ç–µ—Å—Ç—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ Shannon');
}

const router = Router();

// –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–µ–Ω—Ç–µ—Å—Ç—ã
router.get('/', (req: Request, res: Response) => {
  console.log('üì• GET /api/pentests - –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω');
  try {
    console.log('üîç –í—ã–∑—ã–≤–∞—é pentestService.getAllPentests()...');
    const pentests = pentestService.getAllPentests();
    console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${pentests.length} –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤`);
    res.json(pentests);
  } catch (error: any) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤:', error);
    console.error('Stack:', error.stack);
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤',
      details: error?.message || String(error),
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–µ–Ω—Ç–µ—Å—Ç
router.post('/', (req: Request, res: Response) => {
  console.log('üì• POST /api/pentests - –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω');
  console.log('üì¶ Body:', JSON.stringify(req.body, null, 2));
  try {
    const { name, config } = req.body;
    console.log('üîç –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö:', { name, config });

    if (!name || !config || !config.targetUrl) {
      console.warn('‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞:', { hasName: !!name, hasConfig: !!config, hasTargetUrl: !!config?.targetUrl });
      return res.status(400).json({ 
        error: '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å name –∏ config.targetUrl' 
      });
    }

    console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞, —Å–æ–∑–¥–∞—é –ø–µ–Ω—Ç–µ—Å—Ç...');
    const pentest = pentestService.createPentest(name, config as PentestConfig);
    console.log(`‚úÖ –ü–µ–Ω—Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω: ${pentest.id}`);
    res.status(201).json(pentest);
  } catch (error: any) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞:', error);
    console.error('Stack:', error.stack);
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞',
      details: error?.message || String(error),
      stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å –ø–µ–Ω—Ç–µ—Å—Ç –ø–æ ID
router.get('/:id', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    res.json(pentest);
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞' });
  }
});

// –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–µ–Ω—Ç–µ—Å—Ç
router.post('/:id/start', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    if (pentest.status === 'running') {
      return res.status(400).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω' });
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º Shannon –≤ —Ñ–æ–Ω–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç)
    if (shannonService) {
      shannonService.runPentest(id, pentest.config).catch((error: any) => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞:', error);
      });
    } else {
      console.warn('‚ö†Ô∏è shannonService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–µ–Ω—Ç–µ—Å—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω');
    }
    
    res.json({ message: '–ü–µ–Ω—Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω', pentest: pentestService.getPentest(id) });
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–µ–Ω—Ç–µ—Å—Ç–∞' });
  }
});

// –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ–Ω—Ç–µ—Å—Ç
router.post('/:id/stop', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Shannon
    if (shannonService) {
      await shannonService.stopPentest(id);
    } else {
      console.warn('‚ö†Ô∏è shannonService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
    }

    res.json({ message: '–ü–µ–Ω—Ç–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', pentest: pentestService.getPentest(id) });
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–µ–Ω—Ç–µ—Å—Ç–∞' });
  }
});

// –£–¥–∞–ª–∏—Ç—å –ø–µ–Ω—Ç–µ—Å—Ç
router.delete('/:id', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const success = pentestService.deletePentest(id);

    if (!success) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    res.json({ message: '–ü–µ–Ω—Ç–µ—Å—Ç —É–¥–∞–ª–µ–Ω' });
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞' });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –ø–µ–Ω—Ç–µ—Å—Ç–∞
router.get('/:id/logs', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const logs = pentestService.getLogs(id);
    res.json(logs);
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–≥–æ–≤' });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–µ–Ω—Ç–µ—Å—Ç–∞ (–ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ –ª–æ–≥–æ–≤)
router.get('/:id/status', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const logs = pentestService.getLogs(id);
    const { parseStatusFromLogs } = require('../utils/statusParser');
    const status = parseStatusFromLogs(logs);
    res.json({ status });
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞' });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (–ø–∞—Ä—Å–∏–Ω–≥ –∏–∑ –ª–æ–≥–æ–≤)
router.get('/:id/vulnerabilities', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const logs = pentestService.getLogs(id);
    const { parseVulnerabilitiesFromLogs } = require('../utils/vulnerabilityParser');
    const vulnerabilities = parseVulnerabilitiesFromLogs(logs);
    res.json(vulnerabilities);
  } catch (error) {
    res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π' });
  }
});

// –¢–µ—Å—Ç–æ–≤—ã–π endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
router.get('/debug/env', (req: Request, res: Response) => {
  const apiKey = process.env.ANTHROPIC_API_KEY;
  res.json({
    hasApiKey: !!apiKey,
    apiKeyLength: apiKey ? apiKey.length : 0,
    apiKeyPrefix: apiKey ? `${apiKey.substring(0, 15)}...` : '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
    isDefaultKey: apiKey === 'your_api_key_here',
    httpProxy: process.env.HTTP_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
    httpsProxy: process.env.HTTPS_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω',
  });
});

// –ü–æ–ª—É—á–∏—Ç—å –≥—Ä—É–ø–ø—É –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Ü–µ–ª–∏
router.get('/target/:targetUrl/group', (req: Request, res: Response) => {
  try {
    const { targetUrl } = req.params;
    const decodedUrl = decodeURIComponent(targetUrl);
    const group = vulnerabilityTrackingService.getPentestGroup(decodedUrl);
    
    if (!group) {
      return res.status(404).json({ error: '–ì—Ä—É–ø–ø–∞ –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
    }
    
    res.json(group);
  } catch (error: any) {
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤',
      details: error?.message || String(error)
    });
  }
});

// –°—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–∞ –ø–µ–Ω—Ç–µ—Å—Ç–∞
router.get('/compare/:id1/:id2', (req: Request, res: Response) => {
  try {
    const { id1, id2 } = req.params;
    const comparison = vulnerabilityTrackingService.comparePentests(id1, id2);
    
    if (!comparison) {
      return res.status(404).json({ error: '–û–¥–∏–Ω –∏–ª–∏ –æ–±–∞ –ø–µ–Ω—Ç–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã' });
    }
    
    res.json(comparison);
  } catch (error: any) {
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤',
      details: error?.message || String(error)
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å timeline –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è —Ü–µ–ª–∏
router.get('/target/:targetUrl/timeline', (req: Request, res: Response) => {
  try {
    const { targetUrl } = req.params;
    const decodedUrl = decodeURIComponent(targetUrl);
    const timeline = vulnerabilityTrackingService.getProgressTimeline(decodedUrl);
    
    res.json(timeline);
  } catch (error: any) {
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ timeline',
      details: error?.message || String(error)
    });
  }
});

// –ü–æ–ª—É—á–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ–Ω—Ç–µ—Å—Ç–æ–º
router.get('/:id/compare-with-previous', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);
    
    if (!pentest) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—É –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤
    const group = vulnerabilityTrackingService.getPentestGroup(pentest.targetUrl);
    
    if (!group || group.pentests.length < 2) {
      return res.json({ 
        message: '–ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è',
        comparison: null
      });
    }
    
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –ø–µ–Ω—Ç–µ—Å—Ç –≤ –≥—Ä—É–ø–ø–µ
    const currentIndex = group.pentests.findIndex(p => p.id === id);
    
    if (currentIndex === 0) {
      return res.json({ 
        message: '–≠—Ç–æ –ø–µ—Ä–≤—ã–π –ø–µ–Ω—Ç–µ—Å—Ç –¥–ª—è —ç—Ç–æ–π —Ü–µ–ª–∏',
        comparison: null
      });
    }
    
    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
    const previousId = group.pentests[currentIndex - 1].id;
    const comparison = vulnerabilityTrackingService.comparePentests(previousId, id);
    
    res.json({
      previousPentest: group.pentests[currentIndex - 1],
      currentPentest: group.pentests[currentIndex],
      comparison
    });
  } catch (error: any) {
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ–Ω—Ç–µ—Å—Ç–æ–º',
      details: error?.message || String(error)
    });
  }
});

// –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF –æ—Ç—á–µ—Ç
router.get('/:id/generate-pdf', async (req: Request, res: Response) => {
  console.log('üì• GET /api/pentests/:id/generate-pdf - –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ü–ï–†–ï–î –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á–µ—Ç–∞
  const apiKey = process.env.ANTHROPIC_API_KEY;
  console.log(`üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:`);
  console.log(`   ANTHROPIC_API_KEY: ${apiKey ? `–Ω–∞–π–¥–µ–Ω (–¥–ª–∏–Ω–∞: ${apiKey.length})` : '–ù–ï –ù–ê–ô–î–ï–ù'}`);
  console.log(`   HTTP_PROXY: ${process.env.HTTP_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
  console.log(`   HTTPS_PROXY: ${process.env.HTTPS_PROXY || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}`);
  
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: '–ü–µ–Ω—Ç–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
    }

    if (pentest.status !== 'completed') {
      return res.status(400).json({ 
        error: 'PDF –æ—Ç—á–µ—Ç –º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–µ–Ω—Ç–µ—Å—Ç–æ–≤' 
      });
    }

    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF
    const { pdfReportService } = require('../services/pdfReport.service');
    
    console.log(`üöÄ –ù–∞—á–∏–Ω–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é PDF –æ—Ç—á–µ—Ç–∞ –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç–∞ ${id}...`);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    const pdfPath = await pdfReportService.generatePdfReport(id);

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    const fs = require('fs');
    const path = require('path');
    
    if (!fs.existsSync(pdfPath)) {
      return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF' });
    }

    const fileName = path.basename(pdfPath);
    res.setHeader('Content-Type', 'application/pdf');
    res.setHeader('Content-Disposition', `inline; filename="${fileName}"`);
    
    const fileStream = fs.createReadStream(pdfPath);
    fileStream.pipe(res);
  } catch (error: any) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF:', error);
    res.status(500).json({ 
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF',
      details: error?.message || String(error)
    });
  }
});

export default router;
