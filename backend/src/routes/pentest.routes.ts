import { Router, Request, Response } from 'express';
import { pentestService } from '../services/pentest.service';
import { PentestConfig } from '../types/pentest';

// Ленивая загрузка shannonService для избежания ошибок при старте
let shannonService: any = null;
const getShannonService = () => {
  if (!shannonService) {
    try {
      shannonService = require('../services/shannon.service').shannonService;
    } catch (error) {
      console.error('Ошибка при загрузке shannonService:', error);
      throw error;
    }
  }
  return shannonService;
};

const router = Router();

// Получить все пентесты
router.get('/', (req: Request, res: Response) => {
  try {
    const pentests = pentestService.getAllPentests();
    res.json(pentests);
  } catch (error: any) {
    console.error('Ошибка при получении списка пентестов:', error);
    res.status(500).json({ 
      error: 'Ошибка при получении списка пентестов',
      details: error?.message || String(error)
    });
  }
});

// Создать новый пентест
router.post('/', (req: Request, res: Response) => {
  try {
    const { name, config } = req.body;

    if (!name || !config || !config.targetUrl) {
      return res.status(400).json({ 
        error: 'Необходимо указать name и config.targetUrl' 
      });
    }

    const pentest = pentestService.createPentest(name, config as PentestConfig);
    res.status(201).json(pentest);
  } catch (error: any) {
    console.error('Ошибка при создании пентеста:', error);
    res.status(500).json({ 
      error: 'Ошибка при создании пентеста',
      details: error?.message || String(error)
    });
  }
});

// Получить пентест по ID
router.get('/:id', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: 'Пентест не найден' });
    }

    res.json(pentest);
  } catch (error) {
    res.status(500).json({ error: 'Ошибка при получении пентеста' });
  }
});

// Запустить пентест
router.post('/:id/start', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: 'Пентест не найден' });
    }

    if (pentest.status === 'running') {
      return res.status(400).json({ error: 'Пентест уже запущен' });
    }

    // Запускаем Shannon в фоне (не блокируем ответ)
    getShannonService().runPentest(id, pentest.config).catch((error) => {
      console.error('Ошибка при выполнении пентеста:', error);
    });
    
    res.json({ message: 'Пентест запущен', pentest: pentestService.getPentest(id) });
  } catch (error) {
    res.status(500).json({ error: 'Ошибка при запуске пентеста' });
  }
});

// Остановить пентест
router.post('/:id/stop', async (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const pentest = pentestService.getPentest(id);

    if (!pentest) {
      return res.status(404).json({ error: 'Пентест не найден' });
    }

    // Останавливаем Shannon
    await getShannonService().stopPentest(id);

    res.json({ message: 'Пентест остановлен', pentest: pentestService.getPentest(id) });
  } catch (error) {
    res.status(500).json({ error: 'Ошибка при остановке пентеста' });
  }
});

// Удалить пентест
router.delete('/:id', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const success = pentestService.deletePentest(id);

    if (!success) {
      return res.status(404).json({ error: 'Пентест не найден' });
    }

    res.json({ message: 'Пентест удален' });
  } catch (error) {
    res.status(500).json({ error: 'Ошибка при удалении пентеста' });
  }
});

// Получить логи пентеста
router.get('/:id/logs', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const logs = pentestService.getLogs(id);
    res.json(logs);
  } catch (error) {
    res.status(500).json({ error: 'Ошибка при получении логов' });
  }
});

export default router;

